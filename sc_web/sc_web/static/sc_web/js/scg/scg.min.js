var scgLayout=function(a){this._initScgLayout(a)};
scgLayout.prototype={_initScgLayout:function(a){this.config=a;this.config=this._defaultConfig;this._renderer=this._graph=null;this.nodeForce={};this._timeoutCode=0;this.isActive=!1},_defaultConfig:{MAX_REPULSIVE_LENGTH:350,MAX_REPULSIVE_SQUARED:122500,AVG_ATTRACTIVE_LENGTH:100,DEF_START_BOX_HEIGHT:101,MAX_ITERATIONS_CYCLE:21,REPULSIVE_PARAMETER:12E4,ATTRACTIVE_PARAMETER:2,TIME_VELOCITY:1,SCREEN_CENTER_X:200,SCREEN_CENTER_Y:250,MAX_FORCE:15,NUM_STEP_ITERATION:5,MIN_MOVEMENT:1},setGraph:function(a){this._graph=
a},setRenderer:function(a){this._renderer=a},layout:function(){this.isActive=!0;var a=this;this._timeoutCode=setTimeout(function(){var b=a._layoutStep(a.config.NUM_STEP_ITERATION);a._renderer.reDraw();a._renderer._layerNodes.draw();b?a.layout():a.stop()},100)},stop:function(){this.isActive=!1;clearTimeout(this._timeoutCode)},_layoutStep:function(a){for(var b=0;b<a;b++){for(var c in this._graph.nodes){this.setNodeForce(this._graph.nodes[c],0,0);for(var e in this._graph.nodes){if(e==c)break;var d=this.getRelation(this._graph.nodes[c],
this._graph.nodes[e]);if(d.sqDistance>this.config.MAX_REPULSIVE_SQUARED)break;if(0>=d.sqDistance)break;this.addNodeForce(this._graph.nodes[c],d.deltaX,d.deltaY,d.sqDistance,this.getRepulsiveForce(d.sqDistance))}for(e in this._graph.nodes[c]._incidentArcs){d=this._graph.nodes[c]._incidentArcs[e]._endNode;d==this._graph.nodes[c]&&(d=this._graph.nodes[c]._incidentArcs[e]._beginNode);if(d==this._graph.nodes[c])break;d=this.getRelation(this._graph.nodes[c],d);if(0>=d.sqDistance)break;this.addNodeForce(this._graph.nodes[c],
d.deltaX,d.deltaY,d.sqDistance,this.getAttractiveForce(d.sqDistance))}}var f=d=0;for(c in this._graph.nodes){posX=this._graph.nodes[c].getPosition().x;posY=this._graph.nodes[c].getPosition().y;var g=this.getNodeForce(this._graph.nodes[c]).x,h=this.getNodeForce(this._graph.nodes[c]).y;g>this.config.MAX_FORCE&&(g=this.config.MAX_FORCE);g<-this.config.MAX_FORCE&&(g=-this.config.MAX_FORCE);h>this.config.MAX_FORCE&&(h=this.config.MAX_FORCE);h<-this.config.MAX_FORCE&&(h=-this.config.MAX_FORCE);g*=this.config.TIME_VELOCITY;
h*=this.config.TIME_VELOCITY;d=Math.max(d,Math.abs(g));f=Math.max(f,Math.abs(h));this._graph.nodes[c].setPosition(posX+g,posY+h)}if(d<this.config.MIN_MOVEMENT&&f<this.config.MIN_MOVEMENT)return!1}return!0},getRelation:function(a,b){var c=b.getPosition().x-a.getPosition().x,e=b.getPosition().y-a.getPosition().y,d=[];d.deltaX=c;d.deltaY=e;d.sqDistance=c*c+e*e;return d},getArcRelation:function(a,b){var c=b.getPosition().x-a.getPosition().x,e=b.getPosition().y-a.getPosition().y,d=[];d.deltaX=c;d.deltaY=
e;d.sqDistance=c*c+e*e;return d},getRepulsiveForce:function(a){return-this.config.REPULSIVE_PARAMETER/a},getAttractiveForce:function(a){return-this.config.ATTRACTIVE_PARAMETER*(this.config.AVG_ATTRACTIVE_LENGTH-Math.sqrt(a))},setNodeForce:function(a,b,c){this.nodeForce[a.id]={x:b,y:c}},addNodeForce:function(a,b,c,e,d){e=d*d/e;var f=this.nodeForce[a.id];f||(this.nodeForce[a.id]={x:0,y:0},f=this.nodeForce[a.id]);f.x+=b*e*(d%1);f.y+=c*e*(d%1)},getNodeForce:function(a){return this.nodeForce[a.id]}};
var scgScrollBar=function(a){this._initScgScrollBar(a)};
scgScrollBar.prototype={_initScgScrollBar:function(a){this._stage=a.stage;this._scrollableLayer=a.layer;this._getStageRect=a.getStageRect;this._padding=a.padding||100;$(document).on("scg-node-drag",$.proxy(this.updateScroll,this))},getLayer:function(){var a=new Kinetic.Layer,b=new Kinetic.Group,c=new Kinetic.Group,e=this._getHorizontalScroll(),d=this._getVerticalScroll();b.add(e.area);b.add(d.area);c.add(e.bar);c.add(d.bar);c.on("mouseover",function(){document.body.style.cursor="pointer"});c.on("mouseout",
function(){document.body.style.cursor="default"});var f=this,g=function(){f.onDragScroll()};e.bar.on("dragmove",g);d.bar.on("dragmove",g);a.add(b);a.add(c);this.scrolls={horizontal:e.bar,vertical:d.bar};return a},getStageRect:function(){var a=this._getStageRect();a.min.x=Math.min(a.min.x,0);a.min.y=Math.min(a.min.y,0);a.max.x=Math.max(a.max.x,this._stage.getWidth());a.max.y=Math.max(a.max.y,this._stage.getHeight());return a},onDragScroll:function(){var a=this._prepareHorScrollPosition(),b=this._prepareVertScrollPosition(),
c=this.getStageRect(),a={x:-(c.min.x-this._padding+(c.max.x-c.min.x+2*this._padding-this._stage.getWidth())*a),y:-(c.min.y-this._padding+(c.max.y-c.min.y+2*this._padding-this._stage.getHeight())*b)};this._scrollableLayer.setPosition(a);this._scrollableLayer.draw()},_getHorizontalScroll:function(){var a=this._stage,b=new Kinetic.Rect({x:10,y:a.getHeight()-30,width:a.getWidth()-40,height:20,fill:"black",opacity:0.05}),c=new Kinetic.Rect({x:10,y:a.getHeight()-30,width:130,height:20,fill:"#A3989C",draggable:!0,
dragBoundFunc:function(c){c=c.x;10>c?c=10:c>a.getWidth()-160&&(c=a.getWidth()-160);return{x:c,y:this.getAbsolutePosition().y}},opacity:0.5,stroke:"black",strokeWidth:1});return{area:b,bar:c}},_getVerticalScroll:function(){var a=this._stage,b=new Kinetic.Rect({x:a.getWidth()-30,y:10,width:20,height:a.getHeight()-40,fill:"black",opacity:0.05}),c=new Kinetic.Rect({x:a.getWidth()-30,y:10,width:20,height:70,fill:"#A3989C",draggable:!0,dragBoundFunc:function(c){c=c.y;10>c?c=10:c>a.getHeight()-100&&(c=a.getHeight()-
100);return{x:this.getAbsolutePosition().x,y:c}},opacity:0.5,stroke:"black",strokeWidth:1});return{area:b,bar:c}},_prepareHorScrollPosition:function(){return(this.scrolls.horizontal.getPosition().x-10)/(this._stage.getWidth()-170)},_prepareVertScrollPosition:function(){return(this.scrolls.vertical.getPosition().y-10)/(this._stage.getHeight()-110)},updateScroll:function(){}};var scgViewerWindow=function(a){this._initWindow(a)};
scgViewerWindow.prototype={_initWindow:function(a){this.domContainer=a.container;this._currentLanguage=this.renderer=null;this._layout=new scgLayout({});var b=this;$("#"+this.domContainer).on("layoutToogle",function(){b._layout.isActive?b._layout.stop():b._layout.layout()})},receiveData:function(a){(a=this._buildGraph(a))?($("#"+this.domContainer).empty(),delete this.renderer,this.renderer=new scgKineticRenderer({graph:a,container:this.domContainer,width:$("#"+this.domContainer).width(),height:400}),
this._layout=new scgLayout({}),this._layout.setGraph(a),this._layout.setRenderer(this.renderer),this._layout.layout(),this.renderer.render()):console.warn("Build graph error")},_buildGraph:function(a){return GraphBuilder.buildGraph(a)},destroy:function(){this._layout.stop();delete this.renderer;return!0},translateIdentifiers:function(a){var b=this._getObjectsForTranslate(),c=this;SCWeb.core.Translation.translate(b,a,function(a){c._translateObjects(a)})},getIdentifiersLanguage:function(){return this._currentLanguage},
_getObjectsForTranslate:function(){if(null===this.renderer)return[];var a=this.renderer.getGraph().nodes,b=[],c;for(c in a)b.push(c);return b},_translateObjects:function(a){if(null!==this.renderer){var b=this.renderer.getGraph(),c;for(c in a){var e=b.getNodeById(c);e&&(e.idf=a[c])}this.renderer.reDraw();this.renderer._layerNodes.draw()}}};SCgComponent={type:0,outputLang:"hypermedia_format_scg_json",factory:function(a){return new scgViewerWindow(a)},addArgument:function(a){SCWeb.core.Arguments.appendArgument(a)}};
$(document).ready(function(){SCWeb.core.ComponentManager.appendComponentInitialize(function(){SCWeb.core.ComponentManager.registerComponent(SCgComponent)})});var Kinetic={};
(function(){Kinetic.version="4.3.3";Kinetic.Filters={};Kinetic.Plugins={};Kinetic.Global={stages:[],idCounter:0,ids:{},names:{},shapes:{},warn:function(a){window.console&&console.warn&&console.warn("Kinetic warning: "+a)},extend:function(a,b){for(var c in b.prototype)c in a.prototype||(a.prototype[c]=b.prototype[c])},_addId:function(a,b){void 0!==b&&(this.ids[b]=a)},_removeId:function(a){void 0!==a&&delete this.ids[a]},_addName:function(a,b){void 0!==b&&(void 0===this.names[b]&&(this.names[b]=[]),
this.names[b].push(a))},_removeName:function(a,b){if(void 0!==a){var c=this.names[a];if(void 0!==c){for(var e=0;e<c.length;e++)c[e]._id===b&&c.splice(e,1);0===c.length&&delete this.names[a]}}}}})();(function(a,b){"object"===typeof exports?module.exports=b():"function"===typeof define&&define.amd?define(b):a.returnExports=b()})(this,function(){return Kinetic});
(function(){Kinetic.Type={_isElement:function(a){return!!(a&&1==a.nodeType)},_isFunction:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},_isObject:function(a){return!!a&&a.constructor==Object},_isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},_isNumber:function(a){return"[object Number]"==Object.prototype.toString.call(a)},_isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},_hasMethods:function(a){var b=[],c;for(c in a)this._isFunction(a[c])&&
b.push(c);return 0<b.length},_isInDocument:function(a){for(;a=a.parentNode;)if(a==document)return!0;return!1},_getXY:function(a){if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))if(1===a.length){a=a[0];if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))return{x:a[0],y:a[1]};if(this._isObject(a))return a}else{if(2<=a.length)return{x:a[0],y:a[1]}}else if(this._isObject(a))return a;return null},_getSize:function(a){if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a))if(1===
a.length){a=a[0];if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a)){if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a}else{if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a;return null},_getPoints:function(a){if(void 0===a)return[];if(this._isArray(a[0])){for(var b=[],c=0;c<a.length;c++)b.push({x:a[c][0],y:a[c][1]});return b}if(this._isObject(a[0]))return a;
b=[];for(c=0;c<a.length;c+=2)b.push({x:a[c],y:a[c+1]});return b},_getImage:function(a,b){if(a)if(this._isElement(a))b(a);else if(this._isString(a)){var c=new Image;c.onload=function(){b(c)};c.src=a}else if(a.data){var e=document.createElement("canvas");e.width=a.width;e.height=a.height;e.getContext("2d").putImageData(a,0,0);e=e.toDataURL();c=new Image;c.onload=function(){b(c)};c.src=e}else b(null);else b(null)},_rgbToHex:function(a,b,c){return(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1)},_hexToRgb:function(a){a=
parseInt(a,16);return{r:a>>16&255,g:a>>8&255,b:a&255}},_getRandomColorKey:function(){var a=Math.round(255*Math.random()),b=Math.round(255*Math.random()),c=Math.round(255*Math.random());return this._rgbToHex(a,b,c)},_merge:function(a,b){var c=this._clone(b),e;for(e in a)c[e]=this._isObject(a[e])?this._merge(a[e],c[e]):a[e];return c},_clone:function(a){var b={},c;for(c in a)b[c]=this._isObject(a[c])?this._clone(a[c]):a[c];return b},_degToRad:function(a){return a*Math.PI/180},_radToDeg:function(a){return 180*
a/Math.PI}}})();
(function(){var a=document.createElement("canvas").getContext("2d"),b=(window.devicePixelRatio||1)/(a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1);Kinetic.Canvas=function(a,e,d){this.pixelRatio=d||b;this.width=a;this.height=e;this.element=document.createElement("canvas");this.context=this.element.getContext("2d");this.setSize(a||0,e||0)};Kinetic.Canvas.prototype={clear:function(){var a=this.getContext(),
b=this.getElement();a.clearRect(0,0,b.width,b.height)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(a){this.width=a;this.element.width=a*this.pixelRatio;this.element.style.width=a+"px"},setHeight:function(a){this.height=a;this.element.height=a*this.pixelRatio;this.element.style.height=a+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(a,b){this.setWidth(a);this.setHeight(b)},toDataURL:function(a,
b){try{return this.element.toDataURL(a,b)}catch(d){try{return this.element.toDataURL()}catch(f){return Kinetic.Global.warn("Unable to get data URL. "+f.message),""}}},fill:function(a){a.getFillEnabled()&&this._fill(a)},stroke:function(a){a.getStrokeEnabled()&&this._stroke(a)},fillStroke:function(a){var b=a.getFillEnabled();b&&this._fill(a);a.getStrokeEnabled()&&this._stroke(a,a.hasShadow()&&a.hasFill()&&b)},applyShadow:function(a,b){var d=this.context;d.save();this._applyShadow(a);b();d.restore();
b()},_applyLineCap:function(a){if(a=a.getLineCap())this.context.lineCap=a},_applyOpacity:function(a){a=a.getAbsoluteOpacity();1!==a&&(this.context.globalAlpha=a)},_applyLineJoin:function(a){if(a=a.getLineJoin())this.context.lineJoin=a},_applyAncestorTransforms:function(a){var b=this.context;a._eachAncestorReverse(function(a){a=a.getTransform().getMatrix();b.transform(a[0],a[1],a[2],a[3],a[4],a[5])},!0)}};Kinetic.SceneCanvas=function(a,b,d){Kinetic.Canvas.call(this,a,b,d)};Kinetic.SceneCanvas.prototype=
{setWidth:function(a){var b=this.pixelRatio;Kinetic.Canvas.prototype.setWidth.call(this,a);this.context.scale(b,b)},setHeight:function(a){var b=this.pixelRatio;Kinetic.Canvas.prototype.setHeight.call(this,a);this.context.scale(b,b)},_fillColor:function(a){var b=this.context,d=a.getFill();b.fillStyle=d;a._fillFunc(b)},_fillPattern:function(a){var b=this.context,d=a.getFillPatternImage(),f=a.getFillPatternX(),g=a.getFillPatternY(),h=a.getFillPatternScale(),k=a.getFillPatternRotation(),j=a.getFillPatternOffset();
a=a.getFillPatternRepeat();if(f||g)b.translate(f||0,g||0);k&&b.rotate(k);h&&b.scale(h.x,h.y);j&&b.translate(-1*j.x,-1*j.y);b.fillStyle=b.createPattern(d,a||"repeat");b.fill()},_fillLinearGradient:function(a){var b=this.context,d=a.getFillLinearGradientStartPoint(),f=a.getFillLinearGradientEndPoint();a=a.getFillLinearGradientColorStops();d=b.createLinearGradient(d.x,d.y,f.x,f.y);for(f=0;f<a.length;f+=2)d.addColorStop(a[f],a[f+1]);b.fillStyle=d;b.fill()},_fillRadialGradient:function(a){var b=this.context,
d=a.getFillRadialGradientStartPoint(),f=a.getFillRadialGradientEndPoint(),g=a.getFillRadialGradientStartRadius(),h=a.getFillRadialGradientEndRadius();a=a.getFillRadialGradientColorStops();d=b.createRadialGradient(d.x,d.y,g,f.x,f.y,h);for(f=0;f<a.length;f+=2)d.addColorStop(a[f],a[f+1]);b.fillStyle=d;b.fill()},_fill:function(a,b){var d=this.context,f=a.getFill(),g=a.getFillPatternImage(),h=a.getFillLinearGradientStartPoint(),k=a.getFillRadialGradientStartPoint(),j=a.getFillPriority();d.save();!b&&a.hasShadow()&&
this._applyShadow(a);f&&"color"===j?this._fillColor(a):g&&"pattern"===j?this._fillPattern(a):h&&"linear-gradient"===j?this._fillLinearGradient(a):k&&"radial-gradient"===j?this._fillRadialGradient(a):f?this._fillColor(a):g?this._fillPattern(a):h?this._fillLinearGradient(a):k&&this._fillRadialGradient(a);d.restore();!b&&a.hasShadow()&&this._fill(a,!0)},_stroke:function(a,b){var d=this.context,f=a.getStroke(),g=a.getStrokeWidth(),h=a.getDashArray();if(f||g)d.save(),this._applyLineCap(a),h&&a.getDashArrayEnabled()&&
(d.setLineDash?d.setLineDash(h):"mozDash"in d?d.mozDash=h:"webkitLineDash"in d&&(d.webkitLineDash=h)),!b&&a.hasShadow()&&this._applyShadow(a),d.lineWidth=g||2,d.strokeStyle=f||"black",a._strokeFunc(d),d.restore(),!b&&a.hasShadow()&&this._stroke(a,!0)},_applyShadow:function(a){var b=this.context;if(a.hasShadow()&&a.getShadowEnabled()){var d=a.getAbsoluteOpacity(),f=a.getShadowColor()||"black",g=a.getShadowBlur()||5,h=a.getShadowOffset()||{x:0,y:0};a.getShadowOpacity()&&(b.globalAlpha=a.getShadowOpacity()*
d);b.shadowColor=f;b.shadowBlur=g;b.shadowOffsetX=h.x;b.shadowOffsetY=h.y}}};Kinetic.Global.extend(Kinetic.SceneCanvas,Kinetic.Canvas);Kinetic.HitCanvas=function(a,b,d){Kinetic.Canvas.call(this,a,b,d)};Kinetic.HitCanvas.prototype={_fill:function(a){var b=this.context;b.save();b.fillStyle="#"+a.colorKey;a._fillFuncHit(b);b.restore()},_stroke:function(a){var b=this.context,d=a.getStroke(),f=a.getStrokeWidth();if(d||f)this._applyLineCap(a),b.save(),b.lineWidth=f||2,b.strokeStyle="#"+a.colorKey,a._strokeFuncHit(b),
b.restore()}};Kinetic.Global.extend(Kinetic.HitCanvas,Kinetic.Canvas)})();
(function(){Kinetic.Tween=function(a,b,c,e,d,f){this._listeners=[];this.addListener(this);this.obj=a;this.propFunc=b;this._pos=this.begin=e;this.setDuration(f);this.isPlaying=!1;this.prevPos=this.prevTime=this._change=0;this.looping=!1;this._finish=this._startTime=this._position=this._time=0;this.name="";this.func=c;this.setFinish(d)};Kinetic.Tween.prototype={setTime:function(a){this.prevTime=this._time;a>this.getDuration()?this.looping?(this.rewind(a-this._duration),this.update(),this.broadcastMessage("onLooped",
{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):(0>a?this.rewind():this._time=a,this.update())},getTime:function(){return this._time},setDuration:function(a){this._duration=null===a||0>=a?1E5:a},getDuration:function(){return this._duration},setPosition:function(a){this.prevPos=this._pos;this.propFunc(a);this._pos=a;this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(a){void 0===
a&&(a=this._time);return this.func(a,this.begin,this._change,this._duration)},setFinish:function(a){this._change=a-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind();this.startEnterFrame();this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(a){this.stop();this._time=void 0===a?0:a;this.fixTime();this.update()},fforward:function(){this._time=this._duration;this.fixTime();this.update()},update:function(){this.setPosition(this.getPosition(this._time))},
startEnterFrame:function(){this.stopEnterFrame();this.isPlaying=!0;this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1E3)},stop:function(){this.stopEnterFrame();this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(a,b){this.begin=this._pos;this.setFinish(a);void 0!==this._duration&&this.setDuration(b);this.start()},resume:function(){this.fixTime();
this.startEnterFrame();this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(a){this.removeListener(a);return this._listeners.push(a)},removeListener:function(a){for(var b=this._listeners,c=b.length;c--;)if(b[c]==a)return b.splice(c,1),!0;return!1},broadcastMessage:function(){for(var a=[],b=0;b<arguments.length;b++)a.push(arguments[b]);for(var c=a.shift(),e=this._listeners,d=e.length,b=0;b<d;b++)e[b][c]&&e[b][c].apply(e[b],
a)},fixTime:function(){this._startTime=this.getTimer()-1E3*this._time},getTimer:function(){return(new Date).getTime()-this._time}};Kinetic.Tweens={"back-ease-in":function(a,b,c,e){return c*(a/=e)*a*(2.70158*a-1.70158)+b},"back-ease-out":function(a,b,c,e){return c*((a=a/e-1)*a*(2.70158*a+1.70158)+1)+b},"back-ease-in-out":function(a,b,c,e){var d=1.70158;return 1>(a/=e/2)?c/2*a*a*(((d*=1.525)+1)*a-d)+b:c/2*((a-=2)*a*(((d*=1.525)+1)*a+d)+2)+b},"elastic-ease-in":function(a,b,c,e,d,f){var g=0;if(0===a)return b;
if(1==(a/=e))return b+c;f||(f=0.3*e);!d||d<Math.abs(c)?(d=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/d);return-(d*Math.pow(2,10*(a-=1))*Math.sin((a*e-g)*2*Math.PI/f))+b},"elastic-ease-out":function(a,b,c,e,d,f){var g=0;if(0===a)return b;if(1==(a/=e))return b+c;f||(f=0.3*e);!d||d<Math.abs(c)?(d=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/d);return d*Math.pow(2,-10*a)*Math.sin((a*e-g)*2*Math.PI/f)+c+b},"elastic-ease-in-out":function(a,b,c,e,d,f){var g=0;if(0===a)return b;if(2==(a/=e/2))return b+c;f||(f=e*0.3*1.5);
!d||d<Math.abs(c)?(d=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/d);return 1>a?-0.5*d*Math.pow(2,10*(a-=1))*Math.sin((a*e-g)*2*Math.PI/f)+b:0.5*d*Math.pow(2,-10*(a-=1))*Math.sin((a*e-g)*2*Math.PI/f)+c+b},"bounce-ease-out":function(a,b,c,e){return(a/=e)<1/2.75?c*7.5625*a*a+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*a+0.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+0.984375)+b},"bounce-ease-in":function(a,b,c,e){return c-Kinetic.Tweens["bounce-ease-out"](e-a,0,c,e)+b},"bounce-ease-in-out":function(a,
b,c,e){return a<e/2?0.5*Kinetic.Tweens["bounce-ease-in"](2*a,0,c,e)+b:0.5*Kinetic.Tweens["bounce-ease-out"](2*a-e,0,c,e)+0.5*c+b},"ease-in":function(a,b,c,e){return c*(a/=e)*a+b},"ease-out":function(a,b,c,e){return-c*(a/=e)*(a-2)+b},"ease-in-out":function(a,b,c,e){return 1>(a/=e/2)?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},"strong-ease-in":function(a,b,c,e){return c*(a/=e)*a*a*a*a+b},"strong-ease-out":function(a,b,c,e){return c*((a=a/e-1)*a*a*a*a+1)+b},"strong-ease-in-out":function(a,b,c,e){return 1>(a/=e/
2)?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},linear:function(a,b,c,e){return c*a/e+b}}})();
(function(){Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]};Kinetic.Transform.prototype={translate:function(a,b){this.m[4]+=this.m[0]*a+this.m[2]*b;this.m[5]+=this.m[1]*a+this.m[3]*b},scale:function(a,b){this.m[0]*=a;this.m[1]*=a;this.m[2]*=b;this.m[3]*=b},rotate:function(a){var b=Math.cos(a);a=Math.sin(a);var c=this.m[1]*b+this.m[3]*a,e=this.m[0]*-a+this.m[2]*b,d=this.m[1]*-a+this.m[3]*b;this.m[0]=this.m[0]*b+this.m[2]*a;this.m[1]=c;this.m[2]=e;this.m[3]=d},getTranslation:function(){return{x:this.m[4],
y:this.m[5]}},multiply:function(a){var b=this.m[1]*a.m[0]+this.m[3]*a.m[1],c=this.m[0]*a.m[2]+this.m[2]*a.m[3],e=this.m[1]*a.m[2]+this.m[3]*a.m[3],d=this.m[0]*a.m[4]+this.m[2]*a.m[5]+this.m[4],f=this.m[1]*a.m[4]+this.m[3]*a.m[5]+this.m[5];this.m[0]=this.m[0]*a.m[0]+this.m[2]*a.m[1];this.m[1]=b;this.m[2]=c;this.m[3]=e;this.m[4]=d;this.m[5]=f},invert:function(){var a=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),b=-this.m[1]*a,c=-this.m[2]*a,e=this.m[0]*a,d=a*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),
f=a*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=this.m[3]*a;this.m[1]=b;this.m[2]=c;this.m[3]=e;this.m[4]=d;this.m[5]=f},getMatrix:function(){return this.m}}})();
(function(){Kinetic.Collection=function(){var a=[].slice.call(arguments),b=a.length,c=0;for(this.length=b;c<b;c++)this[c]=a[c];return this};Kinetic.Collection.prototype=[];Kinetic.Collection.prototype.apply=function(a){args=[].slice.call(arguments);args.shift();for(var b=0;b<this.length;b++)Kinetic.Type._isFunction(this[b][a])&&this[b][a].apply(this[b],args)};Kinetic.Collection.prototype.each=function(a){for(var b=0;b<this.length;b++)a.call(this[b],b,this[b])}})();
(function(){Kinetic.Filters.Grayscale=function(a){a=a.data;for(var b=0;b<a.length;b+=4){var c=0.34*a[b]+0.5*a[b+1]+0.16*a[b+2];a[b]=c;a[b+1]=c;a[b+2]=c}}})();(function(){Kinetic.Filters.Brighten=function(a,b){for(var c=b.val||0,e=a.data,d=0;d<e.length;d+=4)e[d]+=c,e[d+1]+=c,e[d+2]+=c}})();(function(){Kinetic.Filters.Invert=function(a){a=a.data;for(var b=0;b<a.length;b+=4)a[b]=255-a[b],a[b+1]=255-a[b+1],a[b+2]=255-a[b+2]}})();
(function(){Kinetic.Node=function(a){this._nodeInit(a)};Kinetic.Node.prototype={_nodeInit:function(a){this._id=Kinetic.Global.idCounter++;this.defaultNodeAttrs={visible:!0,listening:!0,name:void 0,opacity:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},draggable:!1,dragOnTop:!0};this.setDefaultAttrs(this.defaultNodeAttrs);this.eventListeners={};this.setAttrs(a)},on:function(a,b){for(var d=a.split(" "),f=d.length,g=0;g<f;g++){var h=d[g].split("."),k=h[0],h=1<h.length?h[1]:"";this.eventListeners[k]||
(this.eventListeners[k]=[]);this.eventListeners[k].push({name:h,handler:b})}},off:function(a){a=a.split(" ");for(var b=a.length,d=0;d<b;d++){var f=a[d],g=f.split("."),h=g[0];if(1<g.length)if(h)this.eventListeners[h]&&this._off(h,g[1]);else for(f in this.eventListeners)this._off(f,g[1]);else delete this.eventListeners[h]}},remove:function(){var a=this.getParent();a&&a.children&&(a.children.splice(this.index,1),a._setChildrenIndices());delete this.parent},destroy:function(){this.getParent();this.getStage();
for(var a=Kinetic.DD,b=Kinetic.Global;this.children&&0<this.children.length;)this.children[0].destroy();b._removeId(this.getId());b._removeName(this.getName(),this._id);a&&(a.node&&a.node._id===this._id)&&node._endDrag();this.trans&&this.trans.stop();this.remove()},getAttrs:function(){return this.attrs},setDefaultAttrs:function(a){void 0===this.attrs&&(this.attrs={});if(a)for(var b in a)void 0===this.attrs[b]&&(this.attrs[b]=a[b])},setAttrs:function(a){if(a)for(var b in a){var d="set"+b.charAt(0).toUpperCase()+
b.slice(1);if(Kinetic.Type._isFunction(this[d]))this[d](a[b]);else this.setAttr(b,a[b])}},getVisible:function(){var a=this.attrs.visible,b=this.getParent();return a&&b&&!b.getVisible()?!1:a},getListening:function(){var a=this.attrs.listening,b=this.getParent();return a&&b&&!b.getListening()?!1:a},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function a(g){for(var h=[],k=g.length,j=0;j<k;j++){var l=g[j];
f++;"Shape"!==l.nodeType&&(h=h.concat(l.getChildren()));l._id===d._id&&(j=k)}0<h.length&&h[0].getLevel()<=b&&a(h)}var b=this.getLevel();this.getStage();var d=this,f=0;"Stage"!==d.nodeType&&a(d.getStage().getChildren());return f},getLevel:function(){for(var a=0,b=this.parent;b;)a++,b=b.parent;return a},setPosition:function(){var a=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("x",a.x);this.setAttr("y",a.y)},getPosition:function(){var a=this.attrs;return{x:a.x,y:a.y}},getAbsolutePosition:function(){var a=
this.getAbsoluteTransform(),b=this.getOffset();a.translate(b.x,b.y);return a.getTranslation()},setAbsolutePosition:function(){var a=Kinetic.Type._getXY([].slice.call(arguments)),b=this._clearTransform();this.attrs.x=b.x;this.attrs.y=b.y;delete b.x;delete b.y;var d=this.getAbsoluteTransform();d.invert();d.translate(a.x,a.y);a={x:this.attrs.x+d.getTranslation().x,y:this.attrs.y+d.getTranslation().y};this.setPosition(a.x,a.y);this._setTransform(b)},move:function(){var a=Kinetic.Type._getXY([].slice.call(arguments)),
b=this.getX(),d=this.getY();void 0!==a.x&&(b+=a.x);void 0!==a.y&&(d+=a.y);this.setPosition(b,d)},_eachAncestorReverse:function(a,b){var d=[],f=this.getParent();for(b&&d.unshift(this);f;)d.unshift(f),f=f.parent;for(var f=d.length,g=0;g<f;g++)a(d[g])},rotate:function(a){this.setRotation(this.getRotation()+a)},rotateDeg:function(a){this.setRotation(this.getRotation()+Kinetic.Type._degToRad(a))},moveToTop:function(){this.parent.children.splice(this.index,1);this.parent.children.push(this);this.parent._setChildrenIndices();
return!0},moveUp:function(){var a=this.index,b=this.parent.getChildren().length;if(a<b-1)return this.parent.children.splice(a,1),this.parent.children.splice(a+1,0,this),this.parent._setChildrenIndices(),!0},moveDown:function(){var a=this.index;if(0<a)return this.parent.children.splice(a,1),this.parent.children.splice(a-1,0,this),this.parent._setChildrenIndices(),!0},moveToBottom:function(){var a=this.index;if(0<a)return this.parent.children.splice(a,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),
!0},setZIndex:function(a){this.parent.children.splice(this.index,1);this.parent.children.splice(a,0,this);this.parent._setChildrenIndices()},getAbsoluteOpacity:function(){var a=this.getOpacity();this.getParent()&&(a*=this.getParent().getAbsoluteOpacity());return a},moveTo:function(a){Kinetic.Node.prototype.remove.call(this);a.add(this)},toObject:function(){var a=Kinetic.Type,b={},d=this.attrs;b.attrs={};for(var f in d){var g=d[f];if(!a._isFunction(g)&&!a._isElement(g)&&(!a._isObject(g)||!a._hasMethods(g)))b.attrs[f]=
g}b.nodeType=this.nodeType;b.shapeType=this.shapeType;return b},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){if(this.getParent())return this.getParent().getStage()},simulate:function(a,b){this._handleEvent(a,b||{})},fire:function(a,b){this._executeHandlers(a,b||{})},getAbsoluteTransform:function(){var a=new Kinetic.Transform;this._eachAncestorReverse(function(b){b=b.getTransform();
a.multiply(b)},!0);return a},getTransform:function(){var a=new Kinetic.Transform,b=this.attrs,d=b.x,f=b.y,g=b.rotation,h=b.scale,k=h.x,h=h.y,j=b.offset,b=j.x,j=j.y;(0!==d||0!==f)&&a.translate(d,f);0!==g&&a.rotate(g);(1!==k||1!==h)&&a.scale(k,h);(0!==b||0!==j)&&a.translate(-1*b,-1*j);return a},clone:function(a){var b=new Kinetic[this.shapeType||this.nodeType](this.attrs),d;for(d in this.eventListeners)for(var f=this.eventListeners[d],g=f.length,h=0;h<g;h++){var k=f[h];0>k.name.indexOf("kinetic")&&
(b.eventListeners[d]||(b.eventListeners[d]=[]),b.eventListeners[d].push(k))}b.setAttrs(a);return b},toDataURL:function(a){a=a||{};var b=a.mimeType||null,d=a.quality||null,f,g=a.x||0,h=a.y||0;a.width&&a.height?a=new Kinetic.SceneCanvas(a.width,a.height,1):(a=this.getStage().bufferCanvas,a.clear());f=a.getContext();f.save();(g||h)&&f.translate(-1*g,-1*h);this.drawScene(a);f.restore();return a.toDataURL(b,d)},toImage:function(a){Kinetic.Type._getImage(this.toDataURL(a),function(b){a.callback(b)})},setSize:function(){var a=
Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(a.width);this.setHeight(a.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},_get:function(a){return this.nodeType===a?[this]:[]},_off:function(a,b){for(var d=0;d<this.eventListeners[a].length;d++)if(this.eventListeners[a][d].name===b){this.eventListeners[a].splice(d,1);if(0===this.eventListeners[a].length){delete this.eventListeners[a];
break}d--}},_clearTransform:function(){var a=this.attrs,b=a.scale,d=a.offset,a={x:a.x,y:a.y,rotation:a.rotation,scale:{x:b.x,y:b.y},offset:{x:d.x,y:d.y}};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scale={x:1,y:1};this.attrs.offset={x:0,y:0};return a},_setTransform:function(a){for(var b in a)this.attrs[b]=a[b]},_fireBeforeChangeEvent:function(a,b,d){this._handleEvent("before"+a.toUpperCase()+"Change",{oldVal:b,newVal:d})},_fireChangeEvent:function(a,b,d){this._handleEvent(a+"Change",
{oldVal:b,newVal:d})},setId:function(a){var b=this.getId();this.getStage();var d=Kinetic.Global;d._removeId(b);d._addId(this,a);this.setAttr("id",a)},setName:function(a){var b=this.getName();this.getStage();var d=Kinetic.Global;d._removeName(b,this._id);d._addName(this,a);this.setAttr("name",a)},setAttr:function(a,b){if(void 0!==b){var d=this.attrs[a];this._fireBeforeChangeEvent(a,d,b);this.attrs[a]=b;this._fireChangeEvent(a,d,b)}},_handleEvent:function(a,b,d){b&&"Shape"===this.nodeType&&(b.shape=
this);this.getStage();var f=this.eventListeners,g=!0;"mouseenter"===a&&d&&this._id===d._id?g=!1:"mouseleave"===a&&(d&&this._id===d._id)&&(g=!1);g&&(f[a]&&this.fire(a,b),b&&(!b.cancelBubble&&this.parent)&&(d&&d.parent?this._handleEvent.call(this.parent,a,b,d.parent):this._handleEvent.call(this.parent,a,b)))},_executeHandlers:function(a,b){for(var d=this.eventListeners[a],f=d.length,g=0;g<f;g++)d[g].handler.apply(this,[b])}};Kinetic.Node.addSetters=function(a,b){for(var d=b.length,f=0;f<d;f++)this._addSetter(a,
b[f])};Kinetic.Node.addPointSetters=function(a,b){for(var d=b.length,f=0;f<d;f++)this._addPointSetter(a,b[f])};Kinetic.Node.addRotationSetters=function(a,b){for(var d=b.length,f=0;f<d;f++)this._addRotationSetter(a,b[f])};Kinetic.Node.addGetters=function(a,b){for(var d=b.length,f=0;f<d;f++)this._addGetter(a,b[f])};Kinetic.Node.addRotationGetters=function(a,b){for(var d=b.length,f=0;f<d;f++)this._addRotationGetter(a,b[f])};Kinetic.Node.addGettersSetters=function(a,b){this.addSetters(a,b);this.addGetters(a,
b)};Kinetic.Node.addPointGettersSetters=function(a,b){this.addPointSetters(a,b);this.addGetters(a,b)};Kinetic.Node.addRotationGettersSetters=function(a,b){this.addRotationSetters(a,b);this.addRotationGetters(a,b)};Kinetic.Node._addSetter=function(a,b){var d="set"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[d]=function(a){this.setAttr(b,a)}};Kinetic.Node._addPointSetter=function(a,b){var d="set"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[d]=function(){var a=Kinetic.Type._getXY([].slice.call(arguments));
a&&void 0===a.x&&(a.x=this.attrs[b].x);a&&void 0===a.y&&(a.y=this.attrs[b].y);this.setAttr(b,a)}};Kinetic.Node._addRotationSetter=function(a,b){var d="set"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[d]=function(a){this.setAttr(b,a)};a.prototype[d+"Deg"]=function(a){this.setAttr(b,Kinetic.Type._degToRad(a))}};Kinetic.Node._addGetter=function(a,b){var d="get"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[d]=function(){return this.attrs[b]}};Kinetic.Node._addRotationGetter=function(a,b){var d=
"get"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[d]=function(){return this.attrs[b]};a.prototype[d+"Deg"]=function(){return Kinetic.Type._radToDeg(this.attrs[b])}};Kinetic.Node.create=function(a,b){return this._createNode(JSON.parse(a),b)};Kinetic.Node._createNode=function(a,b){var d;d="Shape"===a.nodeType?void 0===a.shapeType?"Shape":a.shapeType:a.nodeType;b&&(a.attrs.container=b);d=new Kinetic[d](a.attrs);if(a.children)for(var f=a.children.length,g=0;g<f;g++)d.add(this._createNode(a.children[g]));
return d};Kinetic.Node.addGettersSetters(Kinetic.Node,["x","y","opacity"]);Kinetic.Node.addGetters(Kinetic.Node,["name","id"]);Kinetic.Node.addRotationGettersSetters(Kinetic.Node,["rotation"]);Kinetic.Node.addPointGettersSetters(Kinetic.Node,["scale","offset"]);Kinetic.Node.addSetters(Kinetic.Node,["width","height","listening","visible"]);Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening;Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible;for(var a=["on","off"],
b=0;2>b;b++)(function(b){var e=a[b];Kinetic.Collection.prototype[e]=function(){var a=[].slice.call(arguments);a.unshift(e);this.apply.apply(this,a)}})(b)})();
(function(){Kinetic.Animation=function(a,c){this.func=a;this.node=c;this.id=Kinetic.Animation.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:(new Date).getTime()}};Kinetic.Animation.prototype={isRunning:function(){for(var a=Kinetic.Animation.animations,c=0;c<a.length;c++)if(a[c].id===this.id)return!0;return!1},start:function(){this.stop();this.frame.timeDiff=0;this.frame.lastTime=(new Date).getTime();Kinetic.Animation._addAnimation(this)},stop:function(){Kinetic.Animation._removeAnimation(this)},
_updateFrameObject:function(a){this.frame.timeDiff=a-this.frame.lastTime;this.frame.lastTime=a;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1E3/this.frame.timeDiff}};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=!1;Kinetic.Animation.fixedRequestAnimFrame=function(a){window.setTimeout(a,1E3/60)};Kinetic.Animation._addAnimation=function(a){this.animations.push(a);this._handleAnimation()};Kinetic.Animation._removeAnimation=function(a){a=
a.id;for(var c=this.animations,e=c.length,d=0;d<e;d++)if(c[d].id===a){this.animations.splice(d,1);break}};Kinetic.Animation._runFrames=function(){for(var a={},c=this.animations,e=0;e<c.length;e++){var d=c[e],f=d.node,g=d.func;d._updateFrameObject((new Date).getTime());f&&void 0!==f._id&&(a[f._id]=f);g&&g(d.frame)}for(var h in a)a[h].draw()};Kinetic.Animation._animationLoop=function(){var a=this;0<this.animations.length?(this._runFrames(),Kinetic.Animation.requestAnimFrame(function(){a._animationLoop()})):
this.animRunning=!1};Kinetic.Animation._handleAnimation=function(){this.animRunning||(this.animRunning=!0,this._animationLoop())};RAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Kinetic.Animation.fixedRequestAnimFrame;Kinetic.Animation.requestAnimFrame=function(a){(Kinetic.DD&&Kinetic.DD.moving?this.fixedRequestAnimFrame:RAF)(a)};var a=Kinetic.Node.prototype.moveTo;Kinetic.Node.prototype.moveTo=
function(b){a.call(this,b)}})();
(function(){Kinetic.DD={anim:new Kinetic.Animation,moving:!1,offset:{x:0,y:0}};Kinetic.getNodeDragging=function(){return Kinetic.DD.node};Kinetic.DD._setupDragLayerAndGetContainer=function(a){var c=a.getStage(),e,d;a._eachAncestorReverse(function(a){"Layer"===a.nodeType?(c.dragLayer.setAttrs(a.getAttrs()),e=c.dragLayer,c.add(c.dragLayer)):"Group"===a.nodeType&&(d=new Kinetic.Group(a.getAttrs()),e.add(d),e=d)});return e};Kinetic.DD._initDragLayer=function(a){a.dragLayer=new Kinetic.Layer;a.dragLayer.getCanvas().getElement().className=
"kinetic-drag-and-drop-layer"};Kinetic.DD._drag=function(a){var c=Kinetic.DD,e=c.node;if(e){var d=e.getStage().getUserPosition(),f=e.attrs.dragBoundFunc,d={x:d.x-c.offset.x,y:d.y-c.offset.y};void 0!==f&&(d=f.call(e,d,a));e.setAbsolutePosition(d);c.moving||(c.moving=!0,e.setListening(!1),e._handleEvent("dragstart",a));e._handleEvent("dragmove",a)}};Kinetic.DD._endDrag=function(a){var c=Kinetic.DD,e=c.node;if(e){var d=e.nodeType;e.getStage();e.setListening(!0);if("Stage"===d)e.draw();else{if(("Group"===
d||"Shape"===d)&&e.getDragOnTop()&&c.prevParent)e.moveTo(c.prevParent),e.getStage().dragLayer.remove(),c.prevParent=null;e.getLayer().draw()}delete c.node;c.anim.stop();c.moving&&(c.moving=!1,e._handleEvent("dragend",a))}};Kinetic.Node.prototype._startDrag=function(){var a=Kinetic.DD,c=this,e=this.getStage(),d=e.getUserPosition();if(d){this.getTransform().getTranslation();var f=this.getAbsolutePosition(),g=this.nodeType,h;a.node=this;a.offset.x=d.x-f.x;a.offset.y=d.y-f.y;"Stage"===g||"Layer"===g?
(a.anim.node=this,a.anim.start()):this.getDragOnTop()?(h=a._setupDragLayerAndGetContainer(this),a.anim.node=e.dragLayer,a.prevParent=this.getParent(),setTimeout(function(){a.node&&(c.moveTo(h),a.prevParent.getLayer().draw(),e.dragLayer.draw(),a.anim.start())},0)):(a.anim.node=this.getLayer(),a.anim.start())}};Kinetic.Node.prototype.setDraggable=function(a){this.setAttr("draggable",a);this._dragChange()};Kinetic.Node.prototype.getDraggable=function(){return this.attrs.draggable};Kinetic.Node.prototype.isDragging=
function(){var a=Kinetic.DD;return a.node&&a.node._id===this._id&&a.moving};Kinetic.Node.prototype._listenDrag=function(){this._dragCleanup();var a=this;this.on("mousedown.kinetic touchstart.kinetic",function(c){Kinetic.getNodeDragging()||a._startDrag(c)})};Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var a=this.getStage(),c=Kinetic.DD;a&&(c.node&&c.node._id===this._id)&&c._endDrag()}};Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic");
this.off("touchstart.kinetic")};Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable;Kinetic.Node.addGettersSetters(Kinetic.Node,["dragBoundFunc","dragOnTop"]);var a=document.getElementsByTagName("html")[0];a.addEventListener("mouseup",Kinetic.DD._endDrag,!0);a.addEventListener("touchend",Kinetic.DD._endDrag,!0)})();
(function(){Kinetic.Transition=function(a,b){function c(a,b,d,k){for(var j in a)"duration"!==j&&("easing"!==j&&"callback"!==j)&&(Kinetic.Type._isObject(a[j])?(d[j]={},c(a[j],b[j],d[j],k)):e._add(e._getTween(b,j,a[j],d,k)))}var e=this,d={};this.node=a;this.config=b;this.tweens=[];c(b,a.attrs,d,d);this.tweens[0].onStarted=function(){};this.tweens[0].onStopped=function(){a.transAnim.stop()};this.tweens[0].onResumed=function(){a.transAnim.start()};this.tweens[0].onLooped=function(){};this.tweens[0].onChanged=
function(){};this.tweens[0].onFinished=function(){var c={},d;for(d in b)"duration"!==d&&("easing"!==d&&"callback"!==d)&&(c[d]=b[d]);a.transAnim.stop();a.setAttrs(c);b.callback&&b.callback()}};Kinetic.Transition.prototype={start:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].start()},stop:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].stop()},resume:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].resume()},_onEnterFrame:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].onEnterFrame()},
_add:function(a){this.tweens.push(a)},_getTween:function(a,b,c,e,d){var f=this.config,g=this.node,h=f.easing;void 0===h&&(h="linear");return new Kinetic.Tween(g,function(a){e[b]=a;g.setAttrs(d)},Kinetic.Tweens[h],a[b],c,f.duration)}};Kinetic.Node.prototype.transitionTo=function(a){var b=new Kinetic.Transition(this,a);this.transAnim||(this.transAnim=new Kinetic.Animation);this.transAnim.func=function(){b._onEnterFrame()};this.transAnim.node="Stage"===this.nodeType?this:this.getLayer();b.start();this.transAnim.start();
return this.trans=b}})();
(function(){Kinetic.Container=function(a){this._containerInit(a)};Kinetic.Container.prototype={_containerInit:function(a){this.children=[];Kinetic.Node.call(this,a)},getChildren:function(){return this.children},removeChildren:function(){for(;0<this.children.length;)this.children[0].remove()},add:function(a){var b=this.children;a.index=b.length;a.parent=this;b.push(a);return this},get:function(a){var b=new Kinetic.Collection;if("#"===a.charAt(0))(a=this._getNodeById(a.slice(1)))&&b.push(a);else if("."===
a.charAt(0))a=this._getNodesByName(a.slice(1)),Kinetic.Collection.apply(b,a);else{for(var c=[],e=this.getChildren(),d=e.length,f=0;f<d;f++)c=c.concat(e[f]._get(a));Kinetic.Collection.apply(b,c)}return b},_getNodeById:function(a){this.getStage();a=Kinetic.Global.ids[a];return void 0!==a&&this.isAncestorOf(a)?a:null},_getNodesByName:function(a){return this._getDescendants(Kinetic.Global.names[a]||[])},_get:function(a){for(var b=Kinetic.Node.prototype._get.call(this,a),c=this.getChildren(),e=c.length,
d=0;d<e;d++)b=b.concat(c[d]._get(a));return b},toObject:function(){var a=Kinetic.Node.prototype.toObject.call(this);a.children=[];for(var b=this.getChildren(),c=b.length,e=0;e<c;e++)a.children.push(b[e].toObject());return a},_getDescendants:function(a){for(var b=[],c=a.length,e=0;e<c;e++){var d=a[e];this.isAncestorOf(d)&&b.push(d)}return b},isAncestorOf:function(a){for(a=a.getParent();a;){if(a._id===this._id)return!0;a=a.getParent()}return!1},clone:function(a){a=Kinetic.Node.prototype.clone.call(this,
a);for(var b in this.children)a.add(this.children[b].clone());return a},getIntersections:function(){for(var a=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),b=[],c=this.get("Shape"),e=c.length,d=0;d<e;d++){var f=c[d];f.isVisible()&&f.intersects(a)&&b.push(f)}return b},_setChildrenIndices:function(){for(var a=this.children,b=a.length,c=0;c<b;c++)a[c].index=c},draw:function(){this.drawScene();this.drawHit()},drawScene:function(a){if(this.isVisible())for(var b=this.children,c=b.length,e=
0;e<c;e++)b[e].drawScene(a)},drawHit:function(){if(this.isVisible()&&this.isListening())for(var a=this.children,b=a.length,c=0;c<b;c++)a[c].drawHit()}};Kinetic.Global.extend(Kinetic.Container,Kinetic.Node)})();
(function(){function a(a){a.fill()}function b(a){a.stroke()}function c(a){a.fill()}function e(a){a.stroke()}Kinetic.Shape=function(a){this._initShape(a)};Kinetic.Shape.prototype={_initShape:function(d){this.setDefaultAttrs({fillEnabled:!0,strokeEnabled:!0,shadowEnabled:!0,dashArrayEnabled:!0,fillPriority:"color"});this.nodeType="Shape";this._fillFunc=a;this._strokeFunc=b;this._fillFuncHit=c;this._strokeFuncHit=e;for(var f=Kinetic.Global.shapes,g;!(g=Kinetic.Type._getRandomColorKey())||g in f;);this.colorKey=
g;f[g]=this;Kinetic.Node.call(this,d)},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return!(!this.getShadowColor()&&!this.getShadowBlur()&&!this.getShadowOffset())},hasFill:function(){return!(!this.getFill()&&!this.getFillPatternImage()&&!this.getFillLinearGradientStartPoint()&&!this.getFillRadialGradientStartPoint())},_get:function(a){return this.nodeType===a||this.shapeType===a?[this]:[]},intersects:function(){var a=
Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),b=this.getStage().hitCanvas;b.clear();this.drawScene(b);return 0<b.context.getImageData(Math.round(a.x),Math.round(a.y),1,1).data[3]},enableFill:function(){this.setAttr("fillEnabled",!0)},disableFill:function(){this.setAttr("fillEnabled",!1)},enableStroke:function(){this.setAttr("strokeEnabled",!0)},disableStroke:function(){this.setAttr("strokeEnabled",!1)},enableShadow:function(){this.setAttr("shadowEnabled",!0)},disableShadow:function(){this.setAttr("shadowEnabled",
!1)},enableDashArray:function(){this.setAttr("dashArrayEnabled",!0)},disableDashArray:function(){this.setAttr("dashArrayEnabled",!1)},remove:function(){Kinetic.Node.prototype.remove.call(this);delete Kinetic.Global.shapes[this.colorKey]},drawScene:function(a){var b=this.attrs.drawFunc;a=a||this.getLayer().getCanvas();var c=a.getContext();b&&this.isVisible()&&(c.save(),a._applyOpacity(this),a._applyLineJoin(this),a._applyAncestorTransforms(this),b.call(this,a),c.restore())},drawHit:function(){var a=
this.attrs,a=a.drawHitFunc||a.drawFunc,b=this.getLayer().hitCanvas,c=b.getContext();a&&(this.isVisible()&&this.isListening())&&(c.save(),b._applyLineJoin(this),b._applyAncestorTransforms(this),a.call(this,b),c.restore())},_setDrawFuncs:function(){!this.attrs.drawFunc&&this.drawFunc&&this.setDrawFunc(this.drawFunc);!this.attrs.drawHitFunc&&this.drawHitFunc&&this.setDrawHitFunc(this.drawHitFunc)}};Kinetic.Global.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Node.addGettersSetters(Kinetic.Shape,"stroke lineJoin lineCap strokeWidth drawFunc drawHitFunc dashArray shadowColor shadowBlur shadowOpacity fillPatternImage fill fillPatternX fillPatternY fillLinearGradientColorStops fillRadialGradientStartRadius fillRadialGradientEndRadius fillRadialGradientColorStops fillPatternRepeat fillEnabled strokeEnabled shadowEnabled dashArrayEnabled fillPriority".split(" "));
Kinetic.Node.addPointGettersSetters(Kinetic.Shape,"fillPatternOffset fillPatternScale fillLinearGradientStartPoint fillLinearGradientEndPoint fillRadialGradientStartPoint fillRadialGradientEndPoint shadowOffset".split(" "));Kinetic.Node.addRotationGettersSetters(Kinetic.Shape,["fillPatternRotation"])})();
(function(){Kinetic.Stage=function(a){this._initStage(a)};Kinetic.Stage.prototype={_initStage:function(a){var b=Kinetic.DD;this.setDefaultAttrs({width:400,height:200});Kinetic.Container.call(this,a);this._setStageDefaultProperties();this._id=Kinetic.Global.idCounter++;this._buildDOM();this._bindContentEvents();Kinetic.Global.stages.push(this);b&&b._initDragLayer(this)},setContainer:function(a){"string"===typeof a&&(a=document.getElementById(a));this.setAttr("container",a)},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,
a);this._resizeDOM()},setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,a);this._resizeDOM()},clear:function(){for(var a=this.children,b=0;b<a.length;b++)a[b].clear()},remove:function(){var a=this.content;Kinetic.Node.prototype.remove.call(this);a&&Kinetic.Type._isInDocument(a)&&this.attrs.container.removeChild(a)},reset:function(){this.removeChildren();this._setStageDefaultProperties();this.setAttrs(this.defaultNodeAttrs)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},
getUserPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(a){function b(d){var f=k[d].toDataURL(),m=new Image;m.onload=function(){h.drawImage(m,0,0);d<k.length-1?b(d+1):a.callback(g.toDataURL(c,e))};m.src=f}a=a||{};var c=a.mimeType||null,e=a.quality||null,d=a.x||0,f=a.y||0,g=new Kinetic.SceneCanvas(a.width||this.getWidth(),a.height||this.getHeight()),h=g.getContext(),k=this.children;
(d||f)&&h.translate(-1*d,-1*f);b(0)},toImage:function(a){var b=a.callback;a.callback=function(a){Kinetic.Type._getImage(a,function(a){b(a)})};this.toDataURL(a)},getIntersection:function(a){for(var b=this.getChildren(),c=b.length-1;0<=c;c--){var e=b[c];if(e.isVisible()&&e.isListening()){e=e.hitCanvas.context.getImageData(Math.round(a.x),Math.round(a.y),1,1).data;if(255===e[3])return a=Kinetic.Type._rgbToHex(e[0],e[1],e[2]),a=Kinetic.Global.shapes[a],{shape:a,pixel:e};if(0<e[0]||0<e[1]||0<e[2]||0<e[3])return{pixel:e}}}return null},
_resizeDOM:function(){if(this.content){var a=this.attrs.width,b=this.attrs.height;this.content.style.width=a+"px";this.content.style.height=b+"px";this.bufferCanvas.setSize(a,b,1);this.hitCanvas.setSize(a,b);for(var c=this.children,e=0;e<c.length;e++){var d=c[e];d.getCanvas().setSize(a,b);d.hitCanvas.setSize(a,b);d.draw()}}},add:function(a){Kinetic.Container.prototype.add.call(this,a);a.canvas.setSize(this.attrs.width,this.attrs.height);a.hitCanvas.setSize(this.attrs.width,this.attrs.height);a.draw();
this.content.appendChild(a.canvas.element);return this},getDragLayer:function(){return this.dragLayer},_setUserPosition:function(a){a||(a=window.event);this._setMousePosition(a);this._setTouchPosition(a)},_bindContentEvents:function(){for(var a=this,b="mousedown mousemove mouseup mouseout touchstart touchmove touchend".split(" "),c=0;c<b.length;c++){var e=b[c];(function(){var b=e;a.content.addEventListener(b,function(c){a["_"+b](c)},!1)})()}},_mouseout:function(a){this._setUserPosition(a);var b=Kinetic.DD,
c=this.targetShape;if(c&&(!b||!b.moving))c._handleEvent("mouseout",a),c._handleEvent("mouseleave",a),this.targetShape=null;this.mousePos=void 0},_mousemove:function(a){this._setUserPosition(a);var b=Kinetic.DD,c=this.getIntersection(this.getUserPosition());if(c){var e=c.shape;e&&((!b||!b.moving)&&255===c.pixel[3]&&(!this.targetShape||this.targetShape._id!==e._id)?(this.targetShape&&(this.targetShape._handleEvent("mouseout",a,e),this.targetShape._handleEvent("mouseleave",a,e)),e._handleEvent("mouseover",
a,this.targetShape),e._handleEvent("mouseenter",a,this.targetShape),this.targetShape=e):e._handleEvent("mousemove",a))}else if(this.targetShape&&(!b||!b.moving))this.targetShape._handleEvent("mouseout",a),this.targetShape._handleEvent("mouseleave",a),this.targetShape=null;b&&b._drag(a)},_mousedown:function(a){var b,c=Kinetic.DD;this._setUserPosition(a);if((b=this.getIntersection(this.getUserPosition()))&&b.shape)b=b.shape,this.clickStart=!0,b._handleEvent("mousedown",a);c&&(this.attrs.draggable&&
!c.node)&&this._startDrag(a)},_mouseup:function(a){this._setUserPosition(a);var b=this,c=Kinetic.DD,e=this.getIntersection(this.getUserPosition());if(e&&e.shape&&(e=e.shape,e._handleEvent("mouseup",a),this.clickStart&&(!c||!c.moving||!c.node)))e._handleEvent("click",a),this.inDoubleClickWindow&&e._handleEvent("dblclick",a),this.inDoubleClickWindow=!0,setTimeout(function(){b.inDoubleClickWindow=!1},this.dblClickWindow);this.clickStart=!1},_touchstart:function(a){var b,c=Kinetic.DD;this._setUserPosition(a);
a.preventDefault();if((b=this.getIntersection(this.getUserPosition()))&&b.shape)b=b.shape,this.tapStart=!0,b._handleEvent("touchstart",a);c&&(this.attrs.draggable&&!c.node)&&this._startDrag(a)},_touchend:function(a){this._setUserPosition(a);var b=this,c=Kinetic.DD,e=this.getIntersection(this.getUserPosition());if(e&&e.shape&&(e=e.shape,e._handleEvent("touchend",a),this.tapStart&&(!c||!c.moving||!c.node)))e._handleEvent("tap",a),this.inDoubleClickWindow&&e._handleEvent("dbltap",a),this.inDoubleClickWindow=
!0,setTimeout(function(){b.inDoubleClickWindow=!1},this.dblClickWindow);this.tapStart=!1},_touchmove:function(a){this._setUserPosition(a);var b=Kinetic.DD;a.preventDefault();var c=this.getIntersection(this.getUserPosition());c&&c.shape&&c.shape._handleEvent("touchmove",a);b&&b._drag(a)},_setMousePosition:function(a){var b=a.clientX-this._getContentPosition().left;a=a.clientY-this._getContentPosition().top;this.mousePos={x:b,y:a}},_setTouchPosition:function(a){if(void 0!==a.touches&&1===a.touches.length){var b=
a.touches[0];a=b.clientX-this._getContentPosition().left;b=b.clientY-this._getContentPosition().top;this.touchPos={x:a,y:b}}},_getContentPosition:function(){var a=this.content.getBoundingClientRect();return{top:a.top,left:a.left}},_buildDOM:function(){this.content=document.createElement("div");this.content.style.position="relative";this.content.style.display="inline-block";this.content.className="kineticjs-content";this.attrs.container.appendChild(this.content);this.bufferCanvas=new Kinetic.SceneCanvas;
this.hitCanvas=new Kinetic.HitCanvas;this._resizeDOM()},_onContent:function(a,b){for(var c=a.split(" "),e=0;e<c.length;e++)this.content.addEventListener(c[e],b,!1)},_setStageDefaultProperties:function(){this.nodeType="Stage";this.dblClickWindow=400;this.targetShape=null;this.mousePos=void 0;this.clickStart=!1;this.touchPos=void 0;this.tapStart=!1}};Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Node.addGetters(Kinetic.Stage,["container"])})();
(function(){Kinetic.Layer=function(a){this._initLayer(a)};Kinetic.Layer.prototype={_initLayer:function(a){this.setDefaultAttrs({clearBeforeDraw:!0});this.nodeType="Layer";this.afterDrawFunc=this.beforeDrawFunc=void 0;this.canvas=new Kinetic.SceneCanvas;this.canvas.getElement().style.position="absolute";this.hitCanvas=new Kinetic.HitCanvas;Kinetic.Container.call(this,a)},draw:function(){this.getContext();void 0!==this.beforeDrawFunc&&this.beforeDrawFunc.call(this);Kinetic.Container.prototype.draw.call(this);
void 0!==this.afterDrawFunc&&this.afterDrawFunc.call(this)},drawHit:function(){this.hitCanvas.clear();Kinetic.Container.prototype.drawHit.call(this)},drawScene:function(a){a=a||this.getCanvas();this.attrs.clearBeforeDraw&&a.clear();Kinetic.Container.prototype.drawScene.call(this,a)},toDataURL:function(a){a=a||{};var b=a.mimeType||null,c=a.quality||null;return a.width||a.height||a.x||a.y?Kinetic.Node.prototype.toDataURL.call(this,a):this.getCanvas().toDataURL(b,c)},beforeDraw:function(a){this.beforeDrawFunc=
a},afterDraw:function(a){this.afterDrawFunc=a},getCanvas:function(){return this.canvas},getContext:function(){return this.canvas.context},clear:function(){this.getCanvas().clear()},setVisible:function(a){Kinetic.Node.prototype.setVisible.call(this,a);a?(this.canvas.element.style.display="block",this.hitCanvas.element.style.display="block"):(this.canvas.element.style.display="none",this.hitCanvas.element.style.display="none")},setZIndex:function(a){Kinetic.Node.prototype.setZIndex.call(this,a);var b=
this.getStage();b&&(b.content.removeChild(this.canvas.element),a<b.getChildren().length-1?b.content.insertBefore(this.canvas.element,b.getChildren()[a+1].canvas.element):b.content.appendChild(this.canvas.element))},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var a=this.getStage();a&&(a.content.removeChild(this.canvas.element),a.content.appendChild(this.canvas.element))},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var a=this.getStage();a&&(a.content.removeChild(this.canvas.element),
this.index<a.getChildren().length-1?a.content.insertBefore(this.canvas.element,a.getChildren()[this.index+1].canvas.element):a.content.appendChild(this.canvas.element))}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var a=this.getStage();if(a){var b=a.getChildren();a.content.removeChild(this.canvas.element);a.content.insertBefore(this.canvas.element,b[this.index+1].canvas.element)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var a=this.getStage();
if(a){var b=a.getChildren();a.content.removeChild(this.canvas.element);a.content.insertBefore(this.canvas.element,b[1].canvas.element)}}},getLayer:function(){return this},remove:function(){var a=this.getStage(),b=this.canvas,c=b.element;Kinetic.Node.prototype.remove.call(this);a&&(b&&Kinetic.Type._isInDocument(c))&&a.content.removeChild(c)}};Kinetic.Global.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Node.addGettersSetters(Kinetic.Layer,["clearBeforeDraw"])})();
(function(){Kinetic.Group=function(a){this._initGroup(a)};Kinetic.Group.prototype={_initGroup:function(a){this.nodeType="Group";Kinetic.Container.call(this,a)}};Kinetic.Global.extend(Kinetic.Group,Kinetic.Container)})();
(function(){Kinetic.Rect=function(a){this._initRect(a)};Kinetic.Rect.prototype={_initRect:function(a){this.setDefaultAttrs({width:0,height:0,cornerRadius:0});Kinetic.Shape.call(this,a);this.shapeType="Rect";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext();b.beginPath();var c=this.getCornerRadius(),e=this.getWidth(),d=this.getHeight();0===c?b.rect(0,0,e,d):(b.moveTo(c,0),b.lineTo(e-c,0),b.arc(e-c,c,c,3*Math.PI/2,0,!1),b.lineTo(e,d-c),b.arc(e-c,d-c,c,0,Math.PI/2,!1),b.lineTo(c,d),b.arc(c,
d-c,c,Math.PI/2,Math.PI,!1),b.lineTo(0,c),b.arc(c,c,c,Math.PI,3*Math.PI/2,!1));b.closePath();a.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Rect,["cornerRadius"])})();
(function(){Kinetic.Circle=function(a){this._initCircle(a)};Kinetic.Circle.prototype={_initCircle:function(a){this.setDefaultAttrs({radius:0});Kinetic.Shape.call(this,a);this.shapeType="Circle";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext();b.beginPath();b.arc(0,0,this.getRadius(),0,2*Math.PI,!0);b.closePath();a.fillStroke(this)},getWidth:function(){return 2*this.getRadius()},getHeight:function(){return 2*this.getRadius()},setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,
a);this.setRadius(a/2)},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,a);this.setRadius(a/2)}};Kinetic.Global.extend(Kinetic.Circle,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Circle,["radius"])})();
(function(){Kinetic.Wedge=function(a){this._initWedge(a)};Kinetic.Wedge.prototype={_initWedge:function(a){this.setDefaultAttrs({radius:0,angle:0,clockwise:!1});Kinetic.Shape.call(this,a);this.shapeType="Wedge";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext();b.beginPath();b.arc(0,0,this.getRadius(),0,this.getAngle(),this.getClockwise());b.lineTo(0,0);b.closePath();a.fillStroke(this)},setAngleDeg:function(a){this.setAngle(Kinetic.Type._degToRad(a))},getAngleDeg:function(){return Kinetic.Type._radToDeg(this.getAngle())}};
Kinetic.Global.extend(Kinetic.Wedge,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Wedge,["radius","angle","clockwise"])})();
(function(){Kinetic.Ellipse=function(a){this._initEllipse(a)};Kinetic.Ellipse.prototype={_initEllipse:function(a){this.setDefaultAttrs({radius:{x:0,y:0}});Kinetic.Shape.call(this,a);this.shapeType="Ellipse";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext(),c=this.getRadius();b.beginPath();b.save();c.x!==c.y&&b.scale(1,c.y/c.x);b.arc(0,0,c.x,0,2*Math.PI,!0);b.restore();b.closePath();a.fillStroke(this)},getWidth:function(){return 2*this.getRadius().x},getHeight:function(){return 2*this.getRadius().y},
setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,a);this.setRadius({x:a/2})},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,a);this.setRadius({y:a/2})}};Kinetic.Global.extend(Kinetic.Ellipse,Kinetic.Shape);Kinetic.Node.addPointGettersSetters(Kinetic.Ellipse,["radius"])})();
(function(){Kinetic.Image=function(a){this._initImage(a)};Kinetic.Image.prototype={_initImage:function(a){Kinetic.Shape.call(this,a);this.shapeType="Image";this._setDrawFuncs();var b=this;this.on("imageChange",function(){b._syncSize()});this._syncSize()},drawFunc:function(a){var b=this.getWidth(),c=this.getHeight(),e,d=this,f=a.getContext();f.beginPath();f.rect(0,0,b,c);f.closePath();a.fillStroke(this);this.attrs.image&&(e=this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height?[this.attrs.image,
this.attrs.crop.x||0,this.attrs.crop.y||0,this.attrs.crop.width,this.attrs.crop.height,0,0,b,c]:[this.attrs.image,0,0,b,c],this.hasShadow()?a.applyShadow(this,function(){d._drawImage(f,e)}):this._drawImage(f,e))},drawHitFunc:function(a){var b=this.getWidth(),c=this.getHeight(),e=this.imageHitRegion,d=a.getContext();e?(d.drawImage(e,0,0,b,c),d.beginPath(),d.rect(0,0,b,c),d.closePath(),a.stroke(this)):(d.beginPath(),d.rect(0,0,b,c),d.closePath(),a.fillStroke(this))},applyFilter:function(a,b,c){var e=
new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),d=e.getContext();d.drawImage(this.attrs.image,0,0);try{var f=d.getImageData(0,0,e.getWidth(),e.getHeight());a(f,b);var g=this;Kinetic.Type._getImage(f,function(a){g.setImage(a);c&&c()})}catch(h){Kinetic.Global.warn("Unable to apply filter. "+h.message)}},setCrop:function(){var a=[].slice.call(arguments),b=Kinetic.Type._getXY(a),a=Kinetic.Type._getSize(a),b=Kinetic.Type._merge(b,a);this.setAttr("crop",Kinetic.Type._merge(b,this.getCrop()))},
createImageHitRegion:function(a){var b=new Kinetic.Canvas(this.attrs.width,this.attrs.height),c=b.getContext();c.drawImage(this.attrs.image,0,0);try{for(var e=c.getImageData(0,0,b.getWidth(),b.getHeight()),d=e.data,f=Kinetic.Type._hexToRgb(this.colorKey),b=0,g=d.length;b<g;b+=4)d[b]=f.r,d[b+1]=f.g,d[b+2]=f.b;var h=this;Kinetic.Type._getImage(e,function(b){h.imageHitRegion=b;a&&a()})}catch(k){Kinetic.Global.warn("Unable to create image hit region. "+k.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},
_syncSize:function(){this.attrs.image&&(this.attrs.width||this.setWidth(this.attrs.image.width),this.attrs.height||this.setHeight(this.attrs.image.height))},_drawImage:function(a,b){5===b.length?a.drawImage(b[0],b[1],b[2],b[3],b[4]):9===b.length&&a.drawImage(b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8])}};Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Image,["image"]);Kinetic.Node.addGetters(Kinetic.Image,["crop"])})();
(function(){Kinetic.Polygon=function(a){this._initPolygon(a)};Kinetic.Polygon.prototype={_initPolygon:function(a){this.setDefaultAttrs({points:[]});Kinetic.Shape.call(this,a);this.shapeType="Polygon";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext(),c=this.getPoints(),e=c.length;b.beginPath();b.moveTo(c[0].x,c[0].y);for(var d=1;d<e;d++)b.lineTo(c[d].x,c[d].y);b.closePath();a.fillStroke(this)},setPoints:function(a){this.setAttr("points",Kinetic.Type._getPoints(a))}};Kinetic.Global.extend(Kinetic.Polygon,
Kinetic.Shape);Kinetic.Node.addGetters(Kinetic.Polygon,["points"])})();
(function(){function a(a){a.fillText(this.partialText,0,0)}function b(a){a.strokeText(this.partialText,0,0)}var c="fontFamily fontSize fontStyle padding align lineHeight text width height".split(" "),e=c.length;Kinetic.Text=function(a){this._initText(a)};Kinetic.Text.prototype={_initText:function(d){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",lineHeight:1});this.dummyCanvas=document.createElement("canvas");
Kinetic.Shape.call(this,d);this._fillFunc=a;this._strokeFunc=b;this.shapeType="Text";this._setDrawFuncs();for(d=0;d<e;d++)this.on(c[d]+"Change.kinetic",this._setTextData);this._setTextData()},drawFunc:function(a){var b=a.getContext(),c=this.getPadding(),e=this.getFontStyle(),k=this.getFontSize(),j=this.getFontFamily(),l=this.getTextHeight(),m=this.getLineHeight()*l,p=this.textArr,q=p.length,r=this.getWidth();b.font=e+" "+k+"px "+j;b.textBaseline="middle";b.textAlign="left";b.save();b.translate(c,
0);b.translate(0,c+l/2);for(e=0;e<q;e++)j=p[e],k=j.text,j=j.width,b.save(),"right"===this.getAlign()?b.translate(r-j-2*c,0):"center"===this.getAlign()&&b.translate((r-j-2*c)/2,0),this.partialText=k,a.fillStroke(this),b.restore(),b.translate(0,m);b.restore()},drawHitFunc:function(a){var b=a.getContext(),c=this.getWidth(),e=this.getHeight();b.beginPath();b.rect(0,0,c,e);b.closePath();a.fillStroke(this)},setText:function(a){a=Kinetic.Type._isString(a)?a:a.toString();this.setAttr("text",a)},getWidth:function(){return"auto"===
this.attrs.width?this.getTextWidth()+2*this.getPadding():this.attrs.width},getHeight:function(){return"auto"===this.attrs.height?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+2*this.attrs.padding:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(a){var b=this.dummyCanvas.getContext("2d"),c=this.getFontSize();b.save();b.font=this.getFontStyle()+" "+c+"px "+this.getFontFamily();a=b.measureText(a);
b.restore();return{width:a.width,height:parseInt(c,10)}},_expandTextData:function(a){var b=a.length;n=0;text="";newArr=[];for(n=0;n<b;n++)text=a[n],newArr.push({text:text,width:this._getTextSize(text).width});return newArr},_setTextData:function(){var a=this.getText().split(""),b=[],c=0;addLine=!0;lineHeightPx=0;padding=this.getPadding();this.textWidth=0;this.textHeight=this._getTextSize(this.getText()).height;for(lineHeightPx=this.getLineHeight()*this.textHeight;0<a.length&&addLine&&("auto"===this.attrs.height||
lineHeightPx*(c+1)<this.attrs.height-2*padding);){var e=0,k=void 0;for(addLine=!1;e<a.length;){if(a.indexOf("\n")===e){a.splice(e,1);k=a.splice(0,e).join("");break}var j=a.slice(0,e);if("auto"!==this.attrs.width&&this._getTextSize(j.join("")).width>this.attrs.width-2*padding){if(0==e)break;k=j.lastIndexOf(" ");j=j.lastIndexOf("\n");j=Math.max(k,j);if(0<=j){k=a.splice(0,1+j).join("");break}k=a.splice(0,e).join("");break}e++;e===a.length&&(k=a.splice(0,e).join(""))}this.textWidth=Math.max(this.textWidth,
this._getTextSize(k).width);void 0!==k&&(b.push(k),addLine=!0);c++}this.textArr=this._expandTextData(b)}};Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Text,"fontFamily fontSize fontStyle padding align lineHeight".split(" "));Kinetic.Node.addGetters(Kinetic.Text,["text"])})();
(function(){Kinetic.Line=function(a){this._initLine(a)};Kinetic.Line.prototype={_initLine:function(a){this.setDefaultAttrs({points:[],lineCap:"butt"});Kinetic.Shape.call(this,a);this.shapeType="Line";this._setDrawFuncs()},drawFunc:function(a){var b=this.getPoints(),c=b.length,e=a.getContext();e.beginPath();e.moveTo(b[0].x,b[0].y);for(var d=1;d<c;d++){var f=b[d];e.lineTo(f.x,f.y)}a.stroke(this)},setPoints:function(a){this.setAttr("points",Kinetic.Type._getPoints(a))}};Kinetic.Global.extend(Kinetic.Line,
Kinetic.Shape);Kinetic.Node.addGetters(Kinetic.Line,["points"])})();
(function(){Kinetic.Spline=function(a){this._initSpline(a)};Kinetic.Spline._getControlPoints=function(a,b,c,e){var d=a.x;a=a.y;var f=b.x;b=b.y;var g=c.x;c=c.y;var h=Math.sqrt(Math.pow(f-d,2)+Math.pow(b-a,2)),k=Math.sqrt(Math.pow(g-f,2)+Math.pow(c-b,2)),j=e*h/(h+k);e=e*k/(h+k);return[{x:f-j*(g-d),y:b-j*(c-a)},{x:f+e*(g-d),y:b+e*(c-a)}]};Kinetic.Spline.prototype={_initSpline:function(a){this.setDefaultAttrs({tension:1});Kinetic.Line.call(this,a);this.shapeType="Spline"},drawFunc:function(a){var b=this.getPoints(),
c=b.length,e=a.getContext(),d=this.getTension();e.beginPath();e.moveTo(b[0].x,b[0].y);if(0!==d&&2<c){var f=this.allPoints,g=f.length;e.quadraticCurveTo(f[0].x,f[0].y,f[1].x,f[1].y);for(d=2;d<g-1;)e.bezierCurveTo(f[d].x,f[d++].y,f[d].x,f[d++].y,f[d].x,f[d++].y);e.quadraticCurveTo(f[g-1].x,f[g-1].y,b[c-1].x,b[c-1].y)}else for(d=1;d<c;d++)f=b[d],e.lineTo(f.x,f.y);a.stroke(this)},setPoints:function(a){Kinetic.Line.prototype.setPoints.call(this,a);this._setAllPoints()},setTension:function(a){this.setAttr("tension",
a);this._setAllPoints()},_setAllPoints:function(){for(var a=this.getPoints(),b=a.length,c=this.getTension(),e=[],d=1;d<b-1;d++){var f=Kinetic.Spline._getControlPoints(a[d-1],a[d],a[d+1],c);e.push(f[0]);e.push(a[d]);e.push(f[1])}this.allPoints=e}};Kinetic.Global.extend(Kinetic.Spline,Kinetic.Line);Kinetic.Node.addGetters(Kinetic.Spline,["tension"])})();
(function(){Kinetic.Blob=function(a){this._initBlob(a)};Kinetic.Blob.prototype={_initBlob:function(a){Kinetic.Spline.call(this,a);this.shapeType="Blob"},drawFunc:function(a){var b=this.getPoints(),c=b.length,e=a.getContext(),d=this.getTension();e.beginPath();e.moveTo(b[0].x,b[0].y);if(0!==d&&2<c){b=this.allPoints;c=b.length;for(d=0;d<c-1;)e.bezierCurveTo(b[d].x,b[d++].y,b[d].x,b[d++].y,b[d].x,b[d++].y)}else for(d=1;d<c;d++){var f=b[d];e.lineTo(f.x,f.y)}e.closePath();a.fillStroke(this)},_setAllPoints:function(){var a=
this.getPoints(),b=a.length,c=this.getTension(),e=Kinetic.Spline._getControlPoints(a[b-1],a[0],a[1],c),c=Kinetic.Spline._getControlPoints(a[b-2],a[b-1],a[0],c);Kinetic.Spline.prototype._setAllPoints.call(this);this.allPoints.unshift(e[1]);this.allPoints.push(c[0]);this.allPoints.push(a[b-1]);this.allPoints.push(c[1]);this.allPoints.push(e[0]);this.allPoints.push(a[0])}};Kinetic.Global.extend(Kinetic.Blob,Kinetic.Spline)})();
(function(){Kinetic.Sprite=function(a){this._initSprite(a)};Kinetic.Sprite.prototype={_initSprite:function(a){this.setDefaultAttrs({index:0,frameRate:17});Kinetic.Shape.call(this,a);this.shapeType="Sprite";this._setDrawFuncs();this.anim=new Kinetic.Animation;var b=this;this.on("animationChange",function(){b.setIndex(0)})},drawFunc:function(a){var b=this.attrs.animations[this.attrs.animation][this.attrs.index];a=a.getContext();var c=this.attrs.image;c&&a.drawImage(c,b.x,b.y,b.width,b.height,0,0,b.width,
b.height)},drawHitFunc:function(a){var b=this.attrs.animations[this.attrs.animation][this.attrs.index],c=a.getContext();c.beginPath();c.rect(0,0,b.width,b.height);c.closePath();a.fill(this)},start:function(){var a=this,b=this.getLayer();this.anim.node=b;this.interval=setInterval(function(){var b=a.attrs.index;a._updateIndex();a.afterFrameFunc&&b===a.afterFrameIndex&&(a.afterFrameFunc(),delete a.afterFrameFunc,delete a.afterFrameIndex)},1E3/this.attrs.frameRate);this.anim.start()},stop:function(){this.anim.stop();
clearInterval(this.interval)},afterFrame:function(a,b){this.afterFrameIndex=a;this.afterFrameFunc=b},_updateIndex:function(){this.attrs.index<this.attrs.animations[this.attrs.animation].length-1?this.attrs.index++:this.attrs.index=0}};Kinetic.Global.extend(Kinetic.Sprite,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Sprite,["animation","animations","index"])})();
(function(){Kinetic.Star=function(a){this._initStar(a)};Kinetic.Star.prototype={_initStar:function(a){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0});Kinetic.Shape.call(this,a);this.shapeType="Star";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext(),c=this.attrs.innerRadius,e=this.attrs.outerRadius,d=this.attrs.numPoints;b.beginPath();b.moveTo(0,0-this.attrs.outerRadius);for(var f=1;f<2*d;f++){var g=0===f%2?e:c,h=g*Math.sin(f*Math.PI/d),g=-1*g*Math.cos(f*Math.PI/d);b.lineTo(h,
g)}b.closePath();a.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Star,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Star,["numPoints","innerRadius","outerRadius"])})();
(function(){Kinetic.RegularPolygon=function(a){this._initRegularPolygon(a)};Kinetic.RegularPolygon.prototype={_initRegularPolygon:function(a){this.setDefaultAttrs({radius:0,sides:0});Kinetic.Shape.call(this,a);this.shapeType="RegularPolygon";this._setDrawFuncs()},drawFunc:function(a){var b=a.getContext(),c=this.attrs.sides,e=this.attrs.radius;b.beginPath();b.moveTo(0,0-e);for(var d=1;d<c;d++){var f=e*Math.sin(2*d*Math.PI/c),g=-1*e*Math.cos(2*d*Math.PI/c);b.lineTo(f,g)}b.closePath();a.fillStroke(this)}};
Kinetic.Global.extend(Kinetic.RegularPolygon,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,["radius","sides"])})();
(function(){Kinetic.Path=function(a){this._initPath(a)};Kinetic.Path.prototype={_initPath:function(a){this.dataArray=[];var b=this;Kinetic.Shape.call(this,a);this.shapeType="Path";this._setDrawFuncs();this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange",function(){b.dataArray=Kinetic.Path.parsePathData(b.attrs.data)})},drawFunc:function(a){var b=this.dataArray,c=a.getContext();c.beginPath();for(var e=0;e<b.length;e++){var d=b[e].points;switch(b[e].command){case "L":c.lineTo(d[0],
d[1]);break;case "M":c.moveTo(d[0],d[1]);break;case "C":c.bezierCurveTo(d[0],d[1],d[2],d[3],d[4],d[5]);break;case "Q":c.quadraticCurveTo(d[0],d[1],d[2],d[3]);break;case "A":var f=d[0],g=d[1],h=d[2],k=d[3],j=d[4],l=d[5],m=d[6],d=d[7],p=h>k?h:k,q=h>k?1:h/k,h=h>k?k/h:1;c.translate(f,g);c.rotate(m);c.scale(q,h);c.arc(0,0,p,j,j+l,1-d);c.scale(1/q,1/h);c.rotate(-m);c.translate(-f,-g);break;case "z":c.closePath()}}a.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Path,Kinetic.Shape);Kinetic.Path.getLineLength=
function(a,b,c,e){return Math.sqrt((c-a)*(c-a)+(e-b)*(e-b))};Kinetic.Path.getPointOnLine=function(a,b,c,e,d,f,g){void 0===f&&(f=b);void 0===g&&(g=c);var h=(d-c)/(e-b+1E-8),k=Math.sqrt(a*a/(1+h*h));e<b&&(k*=-1);var j=h*k;if((g-c)/(f-b+1E-8)===h)b={x:f+k,y:g+j};else{j=this.getLineLength(b,c,e,d);if(1E-8>j)return;k=((f-b)*(e-b)+(g-c)*(d-c))/(j*j);j=b+k*(e-b);c+=k*(d-c);f=this.getLineLength(f,g,j,c);a=Math.sqrt(a*a-f*f);k=Math.sqrt(a*a/(1+h*h));e<b&&(k*=-1);b={x:j+k,y:c+h*k}}return b};Kinetic.Path.getPointOnCubicBezier=
function(a,b,c,e,d,f,g,h,k){return{x:h*a*a*a+f*3*a*a*(1-a)+e*3*a*(1-a)*(1-a)+b*(1-a)*(1-a)*(1-a),y:k*a*a*a+g*3*a*a*(1-a)+d*3*a*(1-a)*(1-a)+c*(1-a)*(1-a)*(1-a)}};Kinetic.Path.getPointOnQuadraticBezier=function(a,b,c,e,d,f,g){return{x:f*a*a+e*2*a*(1-a)+b*(1-a)*(1-a),y:g*a*a+d*2*a*(1-a)+c*(1-a)*(1-a)}};Kinetic.Path.getPointOnEllipticalArc=function(a,b,c,e,d,f){var g=Math.cos(f);f=Math.sin(f);c*=Math.cos(d);e*=Math.sin(d);return{x:a+(c*g-e*f),y:b+(c*f+e*g)}};Kinetic.Path.parsePathData=function(a){if(!a)return[];
var b,c="mMlLvVhHzZcCqQtTsSaA".split("");b=a.replace(RegExp(" ","g"),",");for(a=0;a<c.length;a++)b=b.replace(RegExp(c[a],"g"),"|"+c[a]);c=b.split("|");b=[];var e=0,d=0;for(a=1;a<c.length;a++){var f=c[a],g=f.charAt(0),f=f.slice(1),f=f.replace(RegExp(",-","g"),"-"),f=f.replace(RegExp("-","g"),",-"),f=f.replace(RegExp("e,-","g"),"e-"),f=f.split(",");0<f.length&&""===f[0]&&f.shift();for(var h=0;h<f.length;h++)f[h]=parseFloat(f[h]);for(;0<f.length&&!isNaN(f[0]);){var k=null,j=[],h=e,l=d;switch(g){case "l":e+=
f.shift();d+=f.shift();k="L";j.push(e,d);break;case "L":e=f.shift();d=f.shift();j.push(e,d);break;case "m":e+=f.shift();d+=f.shift();k="M";j.push(e,d);g="l";break;case "M":e=f.shift();d=f.shift();k="M";j.push(e,d);g="L";break;case "h":e+=f.shift();k="L";j.push(e,d);break;case "H":e=f.shift();k="L";j.push(e,d);break;case "v":d+=f.shift();k="L";j.push(e,d);break;case "V":d=f.shift();k="L";j.push(e,d);break;case "C":j.push(f.shift(),f.shift(),f.shift(),f.shift());e=f.shift();d=f.shift();j.push(e,d);
break;case "c":j.push(e+f.shift(),d+f.shift(),e+f.shift(),d+f.shift());e+=f.shift();d+=f.shift();k="C";j.push(e,d);break;case "S":var m=e,p=d,k=b[b.length-1];"C"===k.command&&(m=e+(e-k.points[2]),p=d+(d-k.points[3]));j.push(m,p,f.shift(),f.shift());e=f.shift();d=f.shift();k="C";j.push(e,d);break;case "s":m=e;p=d;k=b[b.length-1];"C"===k.command&&(m=e+(e-k.points[2]),p=d+(d-k.points[3]));j.push(m,p,e+f.shift(),d+f.shift());e+=f.shift();d+=f.shift();k="C";j.push(e,d);break;case "Q":j.push(f.shift(),
f.shift());e=f.shift();d=f.shift();j.push(e,d);break;case "q":j.push(e+f.shift(),d+f.shift());e+=f.shift();d+=f.shift();k="Q";j.push(e,d);break;case "T":m=e;p=d;k=b[b.length-1];"Q"===k.command&&(m=e+(e-k.points[0]),p=d+(d-k.points[1]));e=f.shift();d=f.shift();k="Q";j.push(m,p,e,d);break;case "t":m=e;p=d;k=b[b.length-1];"Q"===k.command&&(m=e+(e-k.points[0]),p=d+(d-k.points[1]));e+=f.shift();d+=f.shift();k="Q";j.push(m,p,e,d);break;case "A":var j=f.shift(),m=f.shift(),p=f.shift(),q=f.shift(),r=f.shift(),
s=e,u=d,e=f.shift(),d=f.shift(),k="A",j=this.convertEndpointToCenterParameterization(s,u,e,d,q,r,j,m,p);break;case "a":j=f.shift(),m=f.shift(),p=f.shift(),q=f.shift(),r=f.shift(),s=e,u=d,e+=f.shift(),d+=f.shift(),k="A",j=this.convertEndpointToCenterParameterization(s,u,e,d,q,r,j,m,p)}b.push({command:k||g,points:j,start:{x:h,y:l},pathLength:this.calcLength(h,l,k||g,j)})}("z"===g||"Z"===g)&&b.push({command:"z",points:[],start:void 0,pathLength:0})}return b};Kinetic.Path.calcLength=function(a,b,c,e){var d,
f,g=Kinetic.Path;switch(c){case "L":return g.getLineLength(a,b,e[0],e[1]);case "C":c=0;d=g.getPointOnCubicBezier(0,a,b,e[0],e[1],e[2],e[3],e[4],e[5]);for(t=0.01;1>=t;t+=0.01)f=g.getPointOnCubicBezier(t,a,b,e[0],e[1],e[2],e[3],e[4],e[5]),c+=g.getLineLength(d.x,d.y,f.x,f.y),d=f;return c;case "Q":c=0;d=g.getPointOnQuadraticBezier(0,a,b,e[0],e[1],e[2],e[3]);for(t=0.01;1>=t;t+=0.01)f=g.getPointOnQuadraticBezier(t,a,b,e[0],e[1],e[2],e[3]),c+=g.getLineLength(d.x,d.y,f.x,f.y),d=f;return c;case "A":c=0;f=
e[4];var h=e[5];a=e[4]+h;b=Math.PI/180;Math.abs(f-a)<b&&(b=Math.abs(f-a));d=g.getPointOnEllipticalArc(e[0],e[1],e[2],e[3],f,0);if(0>h)for(t=f-b;t>a;t-=b)f=g.getPointOnEllipticalArc(e[0],e[1],e[2],e[3],t,0),c+=g.getLineLength(d.x,d.y,f.x,f.y),d=f;else for(t=f+b;t<a;t+=b)f=g.getPointOnEllipticalArc(e[0],e[1],e[2],e[3],t,0),c+=g.getLineLength(d.x,d.y,f.x,f.y),d=f;f=g.getPointOnEllipticalArc(e[0],e[1],e[2],e[3],a,0);return c+=g.getLineLength(d.x,d.y,f.x,f.y)}return 0};Kinetic.Path.convertEndpointToCenterParameterization=
function(a,b,c,e,d,f,g,h,k){k*=Math.PI/180;var j=Math.cos(k)*(a-c)/2+Math.sin(k)*(b-e)/2,l=-1*Math.sin(k)*(a-c)/2+Math.cos(k)*(b-e)/2,m=j*j/(g*g)+l*l/(h*h);1<m&&(g*=Math.sqrt(m),h*=Math.sqrt(m));m=Math.sqrt((g*g*h*h-g*g*l*l-h*h*j*j)/(g*g*l*l+h*h*j*j));d==f&&(m*=-1);isNaN(m)&&(m=0);d=m*g*l/h;m=m*-h*j/g;a=(a+c)/2+Math.cos(k)*d-Math.sin(k)*m;b=(b+e)/2+Math.sin(k)*d+Math.cos(k)*m;var p=function(a,b){return(a[0]*b[0]+a[1]*b[1])/(Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.sqrt(b[0]*b[0]+b[1]*b[1]))},q=function(a,
b){return(a[0]*b[1]<a[1]*b[0]?-1:1)*Math.acos(p(a,b))};e=q([1,0],[(j-d)/g,(l-m)/h]);c=[(j-d)/g,(l-m)/h];j=[(-1*j-d)/g,(-1*l-m)/h];l=q(c,j);-1>=p(c,j)&&(l=Math.PI);1<=p(c,j)&&(l=0);0===f&&0<l&&(l-=2*Math.PI);1==f&&0>l&&(l+=2*Math.PI);return[a,b,g,h,e,l,k,f]};Kinetic.Node.addGettersSetters(Kinetic.Path,["data"])})();
(function(){function a(a){a.fillText(this.partialText,0,0)}function b(a){a.strokeText(this.partialText,0,0)}Kinetic.TextPath=function(a){this._initTextPath(a)};Kinetic.TextPath.prototype={_initTextPath:function(c){this.setDefaultAttrs({fontFamily:"Calibri",fontSize:12,fontStyle:"normal",text:""});this.dummyCanvas=document.createElement("canvas");this.dataArray=[];var e=this;Kinetic.Shape.call(this,c);this._fillFunc=a;this._strokeFunc=b;this.shapeType="TextPath";this._setDrawFuncs();this.dataArray=
Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange",function(){e.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});c=["text","textStroke","textStrokeWidth"];for(var d=0;d<c.length;d++)this.on(c[d]+"Change",e._setTextData);e._setTextData()},drawFunc:function(a){var b=a.getContext();b.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;b.textBaseline="middle";b.textAlign="left";b.save();for(var d=this.glyphInfo,f=0;f<d.length;f++){b.save();var g=d[f].p0;
parseFloat(this.attrs.fontSize);b.translate(g.x,g.y);b.rotate(d[f].rotation);this.partialText=d[f].text;a.fillStroke(this);b.restore()}b.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(a){Kinetic.Text.prototype.setText.call(this,a)},_getTextSize:function(a){var b=this.dummyCanvas.getContext("2d");b.save();b.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;a=b.measureText(a);b.restore();return{width:a.width,
height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var a=this._getTextSize(this.attrs.text);this.textWidth=a.width;this.textHeight=a.height;this.glyphInfo=[];for(var a=this.attrs.text.split(""),b,d,f,g=-1,h=0,k=0;k<a.length;k++){a:{var j=this._getTextSize(a[k]).width,l=0,m=0;for(d=void 0;0.01<Math.abs(j-l)/j&&25>m;){m++;for(var p=l;void 0===f;){b:{h=0;f=this.dataArray;for(var q=g+1;q<f.length;q++){if(0<f[q].pathLength){g=q;f=f[q];break b}"M"==f[q].command&&(b={x:f[q].points[0],y:f[q].points[1]})}f=
{}}f&&p+f.pathLength<j&&(p+=f.pathLength,f=void 0)}if(f==={}||void 0===b)break a;p=!1;switch(f.command){case "L":Kinetic.Path.getLineLength(b.x,b.y,f.points[0],f.points[1])>j?d=Kinetic.Path.getPointOnLine(j,b.x,b.y,f.points[0],f.points[1],b.x,b.y):f=void 0;break;case "A":d=f.points[4];var q=f.points[5],r=f.points[4]+q,h=0===h?d+1E-8:j>l?h+Math.PI/180*q/Math.abs(q):h-Math.PI/360*q/Math.abs(q);Math.abs(h)>Math.abs(r)&&(h=r,p=!0);d=Kinetic.Path.getPointOnEllipticalArc(f.points[0],f.points[1],f.points[2],
f.points[3],h,f.points[6]);break;case "C":h=0===h?j>f.pathLength?1E-8:j/f.pathLength:j>l?h+(j-l)/f.pathLength:h-(l-j)/f.pathLength;1<h&&(h=1,p=!0);d=Kinetic.Path.getPointOnCubicBezier(h,f.start.x,f.start.y,f.points[0],f.points[1],f.points[2],f.points[3],f.points[4],f.points[5]);break;case "Q":h=0===h?j/f.pathLength:j>l?h+(j-l)/f.pathLength:h-(l-j)/f.pathLength,1<h&&(h=1,p=!0),d=Kinetic.Path.getPointOnQuadraticBezier(h,f.start.x,f.start.y,f.points[0],f.points[1],f.points[2],f.points[3])}void 0!==d&&
(l=Kinetic.Path.getLineLength(b.x,b.y,d.x,d.y));p&&(f=void 0)}}if(void 0===b||void 0===d)break;j=Kinetic.Path.getLineLength(b.x,b.y,d.x,d.y);j=Kinetic.Path.getPointOnLine(0+j/2,b.x,b.y,d.x,d.y);l=Math.atan2(d.y-b.y,d.x-b.x);this.glyphInfo.push({transposeX:j.x,transposeY:j.y,text:a[k],rotation:l,p0:b,p1:d});b=d}}};Kinetic.Global.extend(Kinetic.TextPath,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.TextPath,["fontFamily","fontSize","fontStyle"]);Kinetic.Node.addGetters(Kinetic.TextPath,["text"])})();
var scArc=function(a,b,c){this._initScArc(a,b,c)};
scArc.prototype={_initScArc:function(a,b,c){this.id=c.id;this.type=parseInt(c.type);this.isArc=!0;this._beginNode=a;this._beginNodePos=c.beginPos;this._endNode=b;this._endNodePos=c.endPos;this._incidentArcs=[];this._breaks=c.breaks||[];this.color=c.color;this._beginNode.addIncidentArc(this);this._endNode.addIncidentArc(this)},addIncidentArc:function(a){this._incidentArcs[a.id]=a;return this},setBeginNode:function(a){this._beginNode=a},setEndNode:function(a){this._endNode=a},getBeginNode:function(){return this._beginNode},
getEndNode:function(){return this._endNode},addBreak:function(a){this._breaks.push(a)},getPosition:function(a){a||(a=0.5);a=Number(a);var b=a%1,c=this._getLines()[a-b];a=c.begin;c=c.end;return{x:a.x-(a.x-c.x)*b,y:a.y-(a.y-c.y)*b}},_getPoints:function(){var a=[];a.push(this._beginNode.getPosition(this._beginNodePos));for(var b=this._breaks,c=0;c<b.length;c++)a.push(b[c]);a.push(this._endNode.getPosition(this._endNodePos));return a},_getLines:function(){for(var a=this._getPoints(),b=[],c=0;c<a.length-
1;c++)b.push({begin:a[c],end:a[c+1]});return b},_getLastLine:function(){var a=this._getLines();return a[a.length-1]},_getFirstLine:function(){return this._getLines()[0]},_getType:function(a){return this.type.split("/")[a]},isAccessory:function(){return(this.type&sc_type_arc_access)==sc_type_arc_access},isOriented:function(){return!0},isNegative:function(){return(this.type&sc_type_positivity_mask)==sc_type_arc_neg},isFuzzy:function(){return(this.type&sc_type_positivity_mask)==sc_type_arc_fuz},isPositive:function(){return(this.type&
sc_type_positivity_mask)==sc_type_arc_pos},isVariable:function(){return(this.type&sc_type_constancy_mask)==sc_type_var},isTemporal:function(){return(this.type&sc_type_permanency_mask)==sc_type_arc_temp},isUndefined:function(){return!1}};var scGraph=function(){this._initScGraph()};
scGraph.prototype={_initScGraph:function(){this.arcs={};this.nodes={}},addArc:function(a){this.arcs[a.id]=a;return this},addNode:function(a){this.nodes[a.id]=a;return this},getArcById:function(a){return this.arcs[a]?this.arcs[a]:null},getNodeById:function(a){return this.nodes[a]},getBoundingRect:function(){var a={x:0,y:0},b={x:0,y:0},c=!0,e=null,d;for(d in this.nodes)e=this.nodes[d].getPosition(),c&&(b.x=a.x=e.x,b.y=a.y=e.y,c=!1),a.x=Math.min(e.x,a.x),a.y=Math.min(e.y,a.y),b.x=Math.max(e.x,b.x),b.y=
Math.max(e.y,b.y);return{min:a,max:b}}};
var GraphBuilder={elementType:{NODE:"node",LINK:"link",ARC:"arc"},nodeType:{LINK:sc_type_node|sc_type_const},LINK_SUFFIX:"_link",buildGraph:function(a){var b=new scGraph,c=[],e=0,d={};for(idx in a){var f=a[idx];if(f.type==this.elementType.NODE){var g=this._buildNode(f);this._initNodePosition(g,e);b.addNode(g);e++;d[f.id]=g}f.type==this.elementType.ARC&&c.push(f);f.type==this.elementType.LINK&&(g=this._buildLinkNode(f),this._initNodePosition(g,e),b.addNode(g),e++,d[f.id]=g)}this._buildArcs(c,d,b);
return b},_buildNode:function(a){return new scNode({id:a.id,idf:a.identifier,type:a.el_type})},_initNodePosition:function(a,b){var c=this._calcXNodePos(b),e=this._calcYNodePos(b);a.setPosition(c,e)},_calcXNodePos:function(a){return 100+25*a},_calcYNodePos:function(a){return 70+30*a},_buildLinkNode:function(a){return new scNode({id:a.id,idf:a.identifier+this.LINK_SUFFIX,type:this.nodeType.LINK})},_buildArcs:function(a,b,c){for(var e=!0;0<a.length&&e;)for(idx in e=!1,a){var d=a[idx],f=d.begin,g=d.end;
b.hasOwnProperty(f)&&b.hasOwnProperty(g)&&(f=this._buildArc(d,b[f],b[g]),e=!0,a.splice(idx,1),b[d.id]=f,c.addArc(f))}},_buildArc:function(a,b,c){return new scArc(b,c,{id:a.id,type:a.el_type})}},scNode=function(a){this._initScNode(a)};
scNode.prototype={_initScNode:function(a){this.id=a.id;this.type=parseInt(a.type);this._incidentArcs=a._incidentArcs||{};this._position=a.position||{};this.color=a.color;this.idf=a.idf||"";this.isActive=!1;this.typeMap={sc_type_node_tuple:"tuple",sc_type_node_struct:"struct",sc_type_node_role:"role",sc_type_node_norole:"relation",sc_type_node_class:"class",sc_type_node_abstract:"abstract",sc_type_node_material:"material"}},getPosition:function(){return this._position},setPosition:function(a,b){a.x&&
a.y?(this._position.x=a.x,this._position.y=a.y):(this._position.x=a,this._position.y=b);return this},addIncidentArc:function(a){this._incidentArcs[a.id]=a;return this},removeIncidentArc:function(a){this._incidentArcs[a.id]&&delete this._incidentArcs[a.id];return this},getStructType:function(){return this.typeMap[this.type&sc_type_node_struct_mask]||"general"},isVariable:function(){return(this.type&sc_type_constancy_mask)==sc_type_var}};var scgArc=function(a,b,c){this._initArc(a,b,c)};
scgArc.prototype={_initArc:function(a,b,c){this._arc=b;this._layer=a;this._drawObject=null;this._renderer=c;this.draw()},getRenderer:function(){return this._renderer},draw:function(){this._draw();if(this._arc.isOriented()){var a=this._prepareArrowPosition(),a=this._getArrow(a.begin,a.end);this._layer.add(a)}this._drawBreaks()},reDraw:function(){this._reDraw();if(this._arc.isOriented()){var a=this._prepareArrowPosition();this._getArrow(a.begin,a.end)}this._drawBreaks()},_draw:function(){var a=new Kinetic.Line(this.__defaultLineConfig),
b=this,c=this._getLineDrawPart();a.setDrawFunc(function(a){b._lineDrawFunc.call(this,a,b,c)});var e=this._prepareLinePoints();a.setPoints(e);this._layer.add(a);this._drawObject=a},moveTo:function(a){var b=a;a||(b=this._layer);a=this._getParts();for(var c=0;c<a.length;c++)a[c].moveTo(b)},_getParts:function(){return[this._drawObject,this._arrow]},_reDraw:function(){this._drawObject.setPoints(this._prepareLinePoints())},_lineDrawFunc:function(a,b,c){b=a.context;for(var e=1;e<this.attrs.points.length;e++){var d=
this.attrs.points[e],f=this.attrs.points[e-1];b.beginPath();for(var g=0;g<c.length;g++)c[g](b,f,d);a.stroke(this)}this.attrs.lineCap&&(b.lineCap=this.attrs.lineCap)},_getLineDrawPart:function(){var a=[],b=this._arc;b.isTemporal()&&b.isVariable()&&a.push(scgDrawFunction.dashVarLine);b.isTemporal()&&!b.isVariable()&&a.push(scgDrawFunction.dashLine);b.isVariable()&&(!b.isTemporal()&&!b.isUndefined(2,3))&&a.push(scgDrawFunction.varLine);b.isNegative()&&a.push(scgDrawFunction.negLine);b.isFuzzy()&&a.push(scgDrawFunction.fuzLine);
switch(b.type){case sc_type_edge_common|sc_type_const:case sc_type_arc_common|sc_type_const:return a.push(scgDrawFunction.undefinedConstPairLine),a;case sc_type_edge_common|sc_type_var:case sc_type_arc_common|sc_type_var:return a.push(scgDrawFunction.undefinedVarPairLine),a;case sc_type_edge_common:case sc_type_arc_common:return a.push(scgDrawFunction.undefinedPairLine),a;case sc_type_arc_access:return a.push(scgDrawFunction.simpleAccessoryLine),a}!b.isVariable()&&!b.isTemporal()&&a.push(scgDrawFunction.simpleLine);
return a},_prepareArrowPosition:function(){var a=this._arc._getLastLine(),b=a.begin,a=a.end,c=a.x-b.x,e=Math.atan((a.y-b.y)/c);0==c&&(e+=Math.PI);var d=0<c?1:-1,c=Math.cos(e)*d,e=Math.sin(e)*d,d=scgConfig.Arc.nodeIndent+8;return{begin:{x:a.x-c*d,y:a.y-e*d},end:b}},_prepareLinePoints:function(){var a=this._arc._getPoints(),b=this._arc._getFirstLine(),c=this._arc._getLastLine(),b=this._prepareLinePositions(b.begin,b.end).end,c=this._prepareLinePositions(c.begin,c.end).begin;a[0]=b;a[a.length-1]=c;return a},
_prepareLinePositions:function(a,b){var c=b.x-a.x,e=Math.atan((b.y-a.y)/c);0==c&&(e+=Math.PI);var d=0<c?1:-1,c=Math.cos(e)*d,e=Math.sin(e)*d,f;f=d=scgConfig.Arc.nodeIndent;this._arc.isOriented()&&(d+=10);return{begin:{x:b.x-c*d,y:b.y-e*d},end:{x:a.x+c*f,y:a.y+e*f}}},_drawBreaks:function(){var a=this._arc._breaks;this._breaks=this._breaks||{};for(var b=0;b<a.length;b++)if(this._breaks[b])this._breaks[b].setPosition(a[b]);else{var c=this._getBreak(a[b]);this._layer.add(c);this._breaks[b]=c}},_getBreak:function(a){var b=
this._defaultBreakConfig;b.x=a.x;b.y=a.y;var c=new Kinetic.Circle(b),e=this;c.on("dragmove",function(){var b=this.getPosition();a.x=b.x;a.y=b.y;e.getRenderer().reDraw()});c.on("mouseover",function(){this.setFill("orange");e._layer.draw()});c.on("mouseout",function(){this.setFill(b.fill);e._layer.draw()});return c},_getArrow:function(a,b){this._arrow||(this._arrow=new Kinetic.Polygon(this.__defaultArrowConfig));this._arrow.setPosition(a);var c=Math.atan2(a.y-b.y,a.x-b.x)-Math.PI/2;c&&this._arrow.setAttrs({rotation:c});
return this._arrow},__defaultArrowConfig:{strokeWidth:1,stroke:"black",fill:"black",lineCap:"butt",points:[-3,-2,3,-2,0,6],rotate:0},_defaultBreakConfig:{x:100,y:100,radius:5,stroke:"#666",fill:"#ddd",strokeWidth:1,draggable:!0},__defaultLineConfig:{strokeWidth:2,stroke:"black",lineCap:"butt",points:[0,0,1,1],lineJoin:"round"}};
var scgDrawFunction={simpleLine:function(a,b,c){a.lineWidth=2;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y)},dashLine:function(a,b,c){var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);a.lineWidth=2;c=scgHelper.getHypotenuse(b,c);c=Math.floor(c/scgConfig.Arc.DASH_HOR_OFFSET);for(var d=0;d<c;d++)d%2?a.lineTo(d*scgConfig.Arc.DASH_HOR_OFFSET,0):a.moveTo(d*scgConfig.Arc.DASH_HOR_OFFSET,0);a.rotate(-e);a.translate(-b.x,-b.y)},dashVarLine:function(a,b,c){var e=Math.atan2(b.y-c.y,b.x-c.x)+
Math.PI;a.translate(b.x,b.y);a.rotate(e);a.lineWidth=2;c=scgHelper.getHypotenuse(b,c);for(var d=-3,f=1;d<c;f++)if(f%2)a.moveTo(d+=8,0);else for(var g=0;4>g;g++)a.lineTo(d+=2,0),a.moveTo(d+=2,0);a.rotate(-e);a.translate(-b.x,-b.y)},negLine:function(a,b,c){var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);a.lineWidth=f;var d=scgConfig.Arc.DASH_VERT_OFFSET,f=scgConfig.Arc.DASH_VERT_WIDTH;c=scgHelper.getHypotenuse(b,c);c=Math.floor(c/d);for(var g=1;g<=c;g++)a.moveTo(g*d,f/2),
a.lineTo(g*d,-f/2);a.rotate(-e);a.translate(-b.x,-b.y)},fuzLine:function(a,b,c){var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);a.lineWidth=f;var d=scgConfig.Arc.DASH_VERT_OFFSET,f=scgConfig.Arc.DASH_VERT_WIDTH;c=scgHelper.getHypotenuse(b,c);c=Math.floor(c/d);for(var g=1;g<=c;g++){var h=g%2;a.moveTo(g*d,h*f/2);a.lineTo(g*d,(h-1)*f/2)}a.rotate(-e);a.translate(-b.x,-b.y)},varLine:function(a,b,c){var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);c=
scgHelper.getHypotenuse(b,c);for(var d=-5,f=1;d<c;f++)if(f%2)a.moveTo(d+=10,0);else{var g=Math.min(c-d,14);a.lineTo(d+=g,0)}a.rotate(-e);a.translate(-b.x,-b.y)},simpleAccessoryLine:function(a,b,c){a.stroke();a.beginPath();var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);a.lineWidth=4;c=scgHelper.getHypotenuse(b,c);for(var d=-5,f=1;d<c;f++)if(f%2)a.moveTo(d+=10,0);else{var g=Math.min(c-d,4);a.lineTo(d+=g,0)}a.rotate(-e);a.translate(-b.x,-b.y);a.stroke()},undefinedPairLine:function(a,
b,c){a.lineWidth=6;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.strokeStyle="#ffffff";a.beginPath();a.lineWidth=4;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.strokeStyle="#000";a.beginPath();var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);a.strokeWidth=1;a.lineWidth=1;c=scgHelper.getHypotenuse(b,c);for(var d=-5,f=1;d<c;f++)if(f%2)a.moveTo(d+=10,0);else{var g=Math.min(c-d,14);a.lineTo(d+=g,0)}a.rotate(-e);a.translate(-b.x,-b.y)},undefinedConstPairLine:function(a,
b,c){a.lineWidth=6;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.strokeStyle="#ffffff";a.beginPath();a.lineWidth=4;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.strokeStyle="#000";a.beginPath()},undefinedVarPairLine:function(a,b,c){a.lineWidth=6;a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.strokeStyle="#ffffff";a.beginPath();a.lineWidth=4;var e=Math.atan2(b.y-c.y,b.x-c.x)+Math.PI;a.translate(b.x,b.y);a.rotate(e);c=scgHelper.getHypotenuse(b,c);for(var d=-5,f=1;d<c;f++)if(f%2)a.moveTo(d+=
10,0);else{var g=Math.min(c-d,14);a.lineTo(d+=g,0)}a.rotate(-e);a.translate(-b.x,-b.y);a.stroke();a.beginPath();a.strokeStyle="#000"}},scgConfig={Arc:{nodeIndent:12,DASH_VERT_OFFSET:24,DASH_VERT_WIDTH:10,DASH_HOR_OFFSET:2},Node:{}},scgHelper={getHypotenuse:function(a,b){var c=Math.abs(a.x-b.x),e=Math.abs(a.y-b.y),d=Math.max(c,e),c=Math.min(c,e)/d;return d*Math.sqrt(1+c*c)}},scgKineticRenderer=function(a){this._initScgKineticRenderer(a)};scgKineticRenderer._renderers=[];
scgKineticRenderer.registerTypeRenderer=function(a,b){scgKineticRenderer._renderers[a]=b;return scgKineticRenderer};scgKineticRenderer.getTypeRenderer=function(a){var b=a&sc_type_element_mask;if(b==sc_type_arc_common||b==sc_type_arc_access||b==sc_type_edge_common)return scgArc;if(b==sc_type_node){if((a&sc_type_constancy_mask)==sc_type_const)return scgNodeConst;if((a&sc_type_constancy_mask)==sc_type_var)return scgNodeVar}throw Error("Undefined type of renderer "+a);};
scgKineticRenderer.prototype={_initScgKineticRenderer:function(a){this._graph=a.graph;this._container=a.container;this._arcs=[];this._nodes=[];this._initProperties(a);a=this._getStage();this._layerArcs=this._layerNodes=new Kinetic.Layer;this._controlLayer=new Kinetic.Layer;this._tmpLayer=new Kinetic.Layer;this.isDragging=!1;this.dragElems=[];a.add(this._layerArcs);a.add(this._layerNodes);a.add(this._tmpLayer);a.add(this._controlLayer);this._controlLayer.add(this.getStopLayoutButton());this._controlLayer.draw();
var b=this,c=new scgScrollBar({stage:a,layer:this._layerNodes,getStageRect:function(){return b._graph.getBoundingRect()}});a.add(c.getLayer())},_initProperties:function(a){for(var b in a)b in this||(this["_"+b]=a[b])},_getStage:function(){this._stage||(this._stage=new Kinetic.Stage({container:this._container,width:this._width,height:this._height}));return this._stage},setGraph:function(a){this._graph=a},getGraph:function(){return this._graph},reDraw:function(){for(var a in this._arcs)this._arcs[a].reDraw();
for(a in this._nodes)this._nodes[a].reDraw()},reDrawRecursive:function(a){a=this.getIncidentElements(a);for(var b=0;b<a.length;b++)a[b].reDraw()},getIncidentElements:function(a){if(!(void 0===this._arcs[a.id]&&void 0===this._nodes[a.id])){var b=[];b.push(this._arcs[a.id]||this._nodes[a.id]);for(var c in a._incidentArcs)b=b.concat(this.getIncidentElements(this._graph.arcs[c]));return b}},onStartDrag:function(a){if(this.isDragging){this.dragElems=a=this.getIncidentElements(a);for(var b=0;b<a.length;b++)a[b].moveTo(this._tmpLayer);
this._tmpLayer.draw();this._layerNodes.draw()}},onEndDrag:function(){this.isDragging=!1;for(var a=0;a<this.dragElems.length;a++)this.dragElems[a].moveTo();this._tmpLayer.draw();this._layerNodes.draw()},render:function(){this._renderNodes();this._renderArcs();this._layerNodes.draw();this._layerArcs.draw()},_renderArcs:function(){var a=this._graph.arcs,b;for(b in a){var c=new (scgKineticRenderer.getTypeRenderer(a[b].type))(this._layerArcs,a[b],this);this._arcs[b]=c}},_renderNodes:function(){var a=this._graph.nodes,
b;for(b in a){var c=new (scgKineticRenderer.getTypeRenderer(a[b].type))(this._layerNodes,a[b],this);this._nodes[b]=c}},getStopLayoutButton:function(){if(!this._layoutStopButton){this._layoutStopButton=new Kinetic.Circle({radius:12,strokeWidth:4,fill:"#FCEBF2",stroke:"#FA5252",x:20,y:20});var a=this;this._layoutStopButton.on("click",function(){$("#"+a._container).trigger("layoutToogle",[a,a._layoutStopButton])})}return this._layoutStopButton}};var scgNode=function(a,b,c){this._initNode(a,b,c)};
scgNode.prototype={_initNode:function(a,b,c){this.id=0;this.layer=a;this.node=b;this.idfDrawObj=null;this.color="#000";this._renderer=c;this.draw();this.reDraw()},getRenderer:function(){return this._renderer},setColor:function(a){this.color=a},draw:function(){this.layer.add(this._getIdf());this._draw();return this},reDraw:function(){var a=this.node.getPosition();this._getIdf().setPosition(a.x+10,a.y+10);this._reDraw();return this},moveTo:function(a){var b=a;a||(b=this.layer);a=this._getParts();for(var c=
0;c<a.length;c++)a[c].moveTo(b)},_getIdf:function(){if(null!=this.idfDrawObj)return this.idfDrawObj.setText(this.node.idf||""),this.idfDrawObj;this._defaultIdfConfig.text=this.node.idf;return this.idfDrawObj=new Kinetic.Text(this._defaultIdfConfig)},_defaultIdfConfig:{x:110,y:110,text:"",fill:"gray"}};var scgNodeConst=function(a,b,c){this._initNodeConst(a,b,c)};
scgNodeConst.prototype={_initNodeConst:function(a,b,c){this._bg=this._circle=null;this._initNode(a,b,c)},_draw:function(){this.layer.add(this._getBg());this.layer.add(this._getCircle());return this},_reDraw:function(){var a=this.node.getPosition();this._getBg().setPosition(a);this._getCircle().setPosition(a);return this},_getParts:function(){return[this._circle,this._bg]},_getCircle:function(){if(null==this._circle){this._circle=new Kinetic.Circle(this._defaultCircleConfig);this._circle.setPosition(this.node.getPosition());
var a=this;this._circle.on("dragmove",function(){a.node.setPosition(this.getPosition());a.getRenderer().reDrawRecursive(a.node)});this._circle.on("mouseover",function(){a.setColor("#f0f");a.getRenderer().reDraw()});this._circle.on("mouseout",function(){a.setColor("#000");a.getRenderer().reDraw()});this._circle.on("click",function(){SCWeb.core.utils.Keyboard.ctrl&&SCgComponent.addArgument(a.node.id)})}this._circle.setStroke(this.color);return this._circle},_getBg:function(){if(null==this._bg){this._bg=
new Kinetic.Shape;var a=this,b=scgNodeVar.drawFunc[this.node.getStructType()];this._bg.setDrawFunc(function(c){c=c.context;c.strokeStyle=a.color;c.fillStyle=a.color;b.call(this,c)})}return this._bg},_defaultCircleConfig:{x:100,y:100,radius:9,stroke:"#000",strokeWidth:4,draggable:!0,dragOnTop:!1}};Kinetic.Global.extend(scgNodeConst,scgNode);
scgNodeConst.drawFunc={general:function(){},relation:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,-7);a.lineTo(7,7);a.moveTo(7,-7);a.lineTo(-7,7);a.stroke()},role:function(a){a.beginPath();a.lineWidth=2;a.moveTo(0,-7);a.lineTo(0,7);a.moveTo(-7,0);a.lineTo(7,0);a.stroke()},group:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,-7);a.lineTo(7,7);a.moveTo(7,-7);a.lineTo(-7,7);a.moveTo(-7,0);a.lineTo(7,0);a.stroke()},tuple:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,0);a.lineTo(7,0);
a.stroke()},"abstract":function(a){a.beginPath();a.lineWidth=1;for(var b=-6;7>b;b+=3)a.moveTo(-7,b),a.lineTo(7,b);a.stroke()},struct:function(a){a.beginPath();a.arc(0,0,2,0,2*Math.PI,!1);a.fill()},material:function(a){a.beginPath();a.rotate(-Math.PI/4);for(var b=-6;7>b;b+=3)a.moveTo(-7,b),a.lineTo(7,b);a.rotate(Math.PI/4);a.stroke()}};var scgNodeVar=function(a,b,c){this._initNodeVar(a,b,c)};
scgNodeVar.prototype={_initNodeVar:function(a,b,c){this._bg=this._rect=null;this._initNode(a,b,c)},_draw:function(){this.layer.add(this._getBg());this.layer.add(this._getRect());return this},_reDraw:function(){var a=this.node.getPosition();this._getBg().setPosition(a);this._getRect().setPosition(a);return this},_getParts:function(){return[this._rect,this._bg]},_getRect:function(){if(null==this._rect){this._rect=new Kinetic.Rect(this._defaultRectConfig);this._rect.setPosition(this.node.getPosition().x,
this.node.getPosition());var a=this;this._rect.on("dragmove",function(){a.node.setPosition(this.getPosition());a.getRenderer().reDrawRecursive(a.node)});this._rect.on("mouseover",function(){a.node.isActive=!0});this._rect.on("mouseout",function(){a.node.isActive=!1});this._rect.on("click",function(){SCWeb.core.utils.Keyboard.ctrl&&SCgComponent.addArgument(a.node.id)})}this._rect.setStroke(this.color);return this._rect},_getBg:function(){if(null==this._bg){this._bg=new Kinetic.Shape;var a=this,b=scgNodeVar.drawFunc[this.node.getStructType()];
this._bg.setDrawFunc(function(c){c=c.context;c.strokeStyle=a.color;c.fillStyle=a.color;b.call(this,c)})}return this._bg},_defaultRectConfig:{x:100,y:100,width:14,height:14,offset:{x:7,y:7},stroke:"#000",strokeWidth:4,draggable:!0,dragOnTop:!1}};
scgNodeVar.drawFunc={general:function(){},relation:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,-7);a.lineTo(7,7);a.moveTo(7,-7);a.lineTo(-7,7);a.stroke()},role:function(a){a.beginPath();a.lineWidth=2;a.moveTo(0,-7);a.lineTo(0,7);a.moveTo(-7,0);a.lineTo(7,0);a.stroke()},group:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,-7);a.lineTo(7,7);a.moveTo(7,-7);a.lineTo(-7,7);a.moveTo(-7,0);a.lineTo(7,0);a.stroke()},tuple:function(a){a.beginPath();a.lineWidth=2;a.moveTo(-7,0);a.lineTo(7,0);a.stroke()},
"abstract":function(a){a.beginPath();a.lineWidth=1;for(var b=-6;7>b;b+=3)a.moveTo(-7,b),a.lineTo(7,b);a.stroke()},struct:function(a){a.beginPath();a.arc(0,0,2,0,2*Math.PI,!1);a.fill()},material:function(a){a.beginPath();a.rotate(-Math.PI/4);for(var b=-6;7>b;b+=3)a.moveTo(-6,b),a.lineTo(6,b);a.rotate(Math.PI/4);a.stroke()}};Kinetic.Global.extend(scgNodeVar,scgNode);